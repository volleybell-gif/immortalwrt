name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch: # 手动触发工作流
  push:
    branches: [ main, master ]
    paths: [ '**' ]
  schedule:
    - cron: '0 2 * * 0' # 每周日凌晨2点自动构建（可选）

env:
  IMAGE_NAME: immortalwrt
  TARGET: ath79
  SUBTARGET: tiny
  # 重要：请根据你的确切路由器型号修改以下PROFILE
  # 常见AR9331设备：tplink_tl-wr703n, tplink_tl-wr740n-v4, gl-inet-6408A-v1
  PROFILE: tplink_tl-wr703n
  
jobs:
  build:
    runs-on: ubuntu-20.04 # 使用 Ubuntu 20.04 确保 Python 2.7 可用

    steps:
    - name: Checkout ImmortalWrt Source Code
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: openwrt-21.02
        submodules: recursive

    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          ccache
          dl
          build_dir
        key: ${{ runner.os }}-immortalwrt-${{ hashFiles('**/.config', '**/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev \
        libncursesw5-dev libssl-dev python2 python2-dev python3 python3-dev \
        python3-distutils python3-setuptools rsync subversion swig time \
        xsltproc zlib1g-dev curl

    - name: Setup ccache
      run: |
        echo "CCACHE_DIR=$(pwd)/ccache" >> $GITHUB_ENV
        ccache --max-size=2G
        ccache -s

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply target configuration
      run: |
        # 创建基础的配置
        cat > .config << EOF
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_tiny=y
CONFIG_TARGET_DEVICE_ath79_tiny_DEVICE_tplink_tl-wr703n=y
CONFIG_TARGET_ROOTFS_PARTSIZE=16
CONFIG_VARIANT=16M
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_kmod-ipt-extra=y
CONFIG_CCACHE=y
EOF
        
        # 应用配置
        make defconfig

    - name: Apply custom configuration files
      run: |
        # 如果有自定义配置文件，复制到正确位置
        if [ -d files ]; then
          echo "复制自定义配置文件..."
          cp -rf files/* .
        fi

    - name: Build firmware
      run: |
        echo "开始构建固件..."
        # 使用所有CPU核心进行构建
        make -j$(nproc) V=s 2>&1 | tee build.log
        
        # 检查是否生成固件 - 修复变量引用语法
        if ls bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/openwrt-*${{ env.PROFILE }}-squashfs-sysupgrade.bin 1> /dev/null 2>&1; then
          echo "固件构建成功!"
          ls -la bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/
        else
          echo "错误：未找到固件文件"
          # 列出目录内容以帮助调试
          echo "目标目录内容:"
          ls -la bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/ || true
          exit 1
        fi

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-${{ env.PROFILE }}-$(date +'%Y%m%d-%H%M')
        path: |
          bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/openwrt-*squashfs-sysupgrade.bin
          bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/config.buildinfo
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.log
          logs/
