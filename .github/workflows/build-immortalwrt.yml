name: Build ImmortalWrt for AR9331 (16M Flash)

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 0'

env:
  IMAGE_NAME: immortalwrt
  TARGET: ath79
  SUBTARGET: tiny
  PROFILE: tplink_tl-wr841n-v11

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout ImmortalWrt Source Code
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: openwrt-21.02
        submodules: recursive

    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          ccache
          dl
          build_dir
        key: ${{ runner.os }}-immortalwrt-${{ hashFiles('**/.config', '**/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-

    - name: Install dependencies
      run: |
        echo "正在安装构建依赖..."
        sudo apt-get update
        
        # Ubuntu 22.04安装Python 2.7
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:deadsnakes/ppa
        sudo apt-get update
        sudo apt-get install -y python2.7 python2.7-dev
        
        # 创建符号链接
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        
        # 安装其他构建依赖
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
        gettext git java-propose-classpath libelf-dev libncurses5-dev \
        libncursesw5-dev libssl-dev python3 python3-dev python3-distutils \
        python3-setuptools rsync subversion swig time xsltproc zlib1g-dev curl
        
        echo "依赖安装完成！"

    - name: Setup ccache
      run: |
        echo "设置ccache缓存..."
        echo "CCACHE_DIR=$(pwd)/ccache" >> $GITHUB_ENV
        ccache --max-size=2G
        ccache -s

    - name: Update feeds
      run: |
        echo "更新feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "feeds更新完成！"

    - name: Create and apply configuration
      run: |
        echo "创建和应用配置..."
        
        # 方法1：使用diffconfig文件（推荐）
        cat > ar9331.config << 'EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_tiny=y
CONFIG_TARGET_DEVICE_ath79_tiny_DEVICE_tplink_tl-wr841n-v11=y
CONFIG_TARGET_ROOTFS_PARTSIZE=16000
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath9k-common=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-ipopt=y
CONFIG_PACKAGE_iptables-mod-nat-extra=y
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_wpad-basic=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_luci=n
CONFIG_PACKAGE_luci-compat=n
CONFIG_PACKAGE_luci-theme-bootstrap=n
CONFIG_CCACHE=y
EOF
        
        # 应用配置
        cat ar9331.config >> .config
        make defconfig
        
        echo "验证配置..."
        echo "=== 当前配置摘要 ==="
        echo "目标设备:"
        grep "CONFIG_TARGET_DEVICE" .config || true
        echo ""
        echo "固件大小设置:"
        grep "CONFIG_TARGET_ROOTFS" .config || true
        echo ""
        echo "无线驱动:"
        grep "CONFIG_PACKAGE.*ath9k" .config || true

    - name: Apply custom configuration files
      run: |
        echo "应用自定义配置文件..."
        # 创建files目录结构
        mkdir -p files/etc/config
        
        # 创建网络配置文件
        cat > files/etc/config/network << 'EOF'
config interface 'loopback'
    option device 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config interface 'lan'
    option device 'eth0'
    option proto 'static'
    option ipaddr '192.168.1.1'
    option netmask '255.255.255.0'
    option ip6assign '60'
EOF
        
        # 创建无线配置文件
        cat > files/etc/config/wireless << 'EOF'
config wifi-device 'radio0'
    option type 'mac80211'
    option channel '11'
    option hwmode '11g'
    option path 'platform/ar933x_wmac'
    option htmode 'HT20'
    option disabled '0'
    option country 'US'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid 'ImmortalWrt'
    option encryption 'none'
EOF
        
        echo "自定义配置文件创建完成！"

    - name: Build firmware (multithreaded)
      run: |
        echo "开始多线程构建固件..."
        CPU_CORES=$(nproc)
        THREADS=$((CPU_CORES + 1))
        echo "使用构建线程数: $THREADS"
        
        # 清理之前的构建（可选）
        # make clean
        
        # 使用ccache和多线程加速构建
        make -j$THREADS V=s 2>&1 | tee build.log
        
        echo "构建完成，检查结果..."

    - name: Check build results
      run: |
        echo "检查构建结果..."
        
        # 检查固件是否生成
        if find bin/targets -name "*squashfs-sysupgrade.bin" 2>/dev/null | head -1 | grep -q .; then
          echo "固件构建成功！"
          echo "生成的固件："
          find bin/targets -name "*squashfs-sysupgrade.bin" -exec ls -la {} \;
          
          # 检查固件大小
          for f in bin/targets/*/*/*squashfs-sysupgrade.bin; do
            if [ -f "$f" ]; then
              size=$(stat -c%s "$f")
              size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
              echo "固件 $f 大小: ${size_mb}MB"
              # 检查是否超过14MB
              if [ $size -gt 14680064 ]; then
                echo "警告：固件超过14MB！"
              fi
            fi
          done
        else
          echo "错误：未找到固件文件"
          echo "构建日志最后50行："
          tail -50 build.log
          echo "检查.config文件："
          grep "CONFIG_TARGET" .config || true
          exit 1
        fi

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-16m-$(date +'%Y%m%d-%H%M')
        path: |
          bin/targets/**/*squashfs-sysupgrade.bin
          bin/targets/**/config.buildinfo
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.log
