name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 0'

env:
  IMAGE_NAME: immortalwrt
  TARGET: ath79
  SUBTARGET: tiny
  PROFILE: tplink_tl-wr703n

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout ImmortalWrt Source Code
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: openwrt-21.02
        submodules: recursive

    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          ccache
          dl
          build_dir
        key: ${{ runner.os }}-immortalwrt-${{ hashFiles('**/.config', '**/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-

    - name: Install dependencies
      run: |
        echo "正在安装构建依赖..."
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python2 python2-dev python3 python3-dev python3-distutils python3-setuptools rsync subversion swig time xsltproc zlib1g-dev curl
        echo "依赖安装完成！"

    - name: Setup ccache
      run: |
        echo "设置ccache缓存..."
        echo "CCACHE_DIR=$(pwd)/ccache" >> $GITHUB_ENV
        ccache --max-size=2G
        ccache -s

    - name: Update feeds
      run: |
        echo "更新feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "feeds更新完成！"

    - name: Apply target configuration
      run: |
        echo "应用目标配置..."
        cat > .config << 'EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_tiny=y
CONFIG_TARGET_DEVICE_ath79_tiny_DEVICE_tplink_tl-wr703n=y
CONFIG_TARGET_ROOTFS_PARTSIZE=16
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_kmod-ipt-extra=y
CONFIG_CCACHE=y
EOF
        echo "配置已写入.config文件"
        make defconfig
        echo "基础配置应用完成！"

    - name: Apply custom configuration files
      run: |
        echo "检查自定义配置文件..."
        if [ -d files ]; then
          echo "找到自定义配置文件，正在复制..."
          cp -rf files/* .
          echo "自定义配置文件复制完成！"
        else
          echo "未找到自定义配置文件"
        fi

    - name: Build firmware
      run: |
        echo "开始构建固件..."
        CPU_CORES=$(nproc)
        echo "使用CPU核心数: $CPU_CORES"
        echo "开始编译过程..."
        make -j$(nproc) V=s 2>&1 | tee build.log
        echo "编译完成！"
        
        echo "检查生成的固件文件..."
        FIRMWARE_PATH="bin/targets/$TARGET/$SUBTARGET"
        echo "固件路径: $FIRMWARE_PATH"
        
        if ls "$FIRMWARE_PATH"/openwrt-*"$PROFILE"*squashfs-sysupgrade.bin > /dev/null 2>&1; then
          echo "固件构建成功!"
          echo "生成的固件文件:"
          ls -la "$FIRMWARE_PATH"/openwrt-*"$PROFILE"*squashfs-sysupgrade.bin
        else
          echo "错误：未找到固件文件"
          echo "目标目录内容:"
          ls -la "$FIRMWARE_PATH" || true
          exit 1
        fi

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-${{ env.PROFILE }}-$(date +'%Y%m%d-%H%M')
        path: |
          bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/openwrt-*squashfs-sysupgrade.bin
          bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/config.buildinfo
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.log
          logs/
