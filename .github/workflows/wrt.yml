name: Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt branch version'
        required: true
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup cache for toolchain
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          immortalwrt/dl
        key: ${{ runner.os }}-openwrt-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean

    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 --single-branch https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.branch }}

    - name: Configure for TL-WR703N 16MB
      run: |
        cd immortalwrt
        
        # 使用多个echo命令代替多行字符串，避免YAML语法问题
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_BUSYBOX_CUSTOM=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
        echo "CONFIG_ATH_USER_REGD=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config

        make defconfig

    - name: Build with optimizations
      run: |
        cd immortalwrt
        
        echo "开始编译..."
        echo "CPU核心数: $(nproc)"
        echo "内存: $(free -h | awk '/Mem:/ {print $2}')"
        echo "开始时间: $(date)"
        
        # 使用ccache加速
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_MAXSIZE=2G
        
        # 分阶段编译，避免一次性编译所有工具
        echo "阶段1: 编译工具链"
        make toolchain/compile -j$(nproc) 2>&1 | tee -a build.log
        
        echo "阶段2: 编译内核"
        make target/linux/compile -j$(nproc) 2>&1 | tee -a build.log
        
        echo "阶段3: 编译基础包"
        make package/base-files/compile -j$(nproc) 2>&1 | tee -a build.log
        make package/busybox/compile -j$(nproc) 2>&1 | tee -a build.log
        
        echo "阶段4: 最终编译"
        make -j$(nproc) 2>&1 | tee -a build.log
        
        echo "完成时间: $(date)"

    - name: Check firmware
      run: |
        cd immortalwrt
        
        if ls bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin 1>/dev/null 2>&1; then
          echo "✅ 找到固件文件:"
          ls -lh bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin
        else
          echo "❌ 未找到固件"
          ls -la bin/targets/ar71xx/generic/ 2>/dev/null || echo "目录不存在"
        fi

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/
