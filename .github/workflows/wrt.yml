name: Ultimate TL-WR703N 16MB Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean
        
    - name: Clone fresh source
      run: |
        # å®Œå…¨é‡æ–°å¼€å§‹ï¼Œé¿å…ä¹‹å‰çš„ç¼“å­˜é—®é¢˜
        rm -rf immortalwrt 2>/dev/null || true
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git
        
    - name: Force configure for ar71xx only
      run: |
        cd immortalwrt
        
        echo "ðŸ§¹ å®Œå…¨æ¸…ç†..."
        rm -rf bin build_dir staging_dir tmp logs .config feeds.conf.default 2>/dev/null || true
        
        echo "ðŸŽ¯ å¼ºåˆ¶è®¾ç½®åªç¼–è¯‘ ar71xx..."
        
        # ç¬¬ä¸€æ­¥ï¼šå…ˆé€‰æ‹©æž¶æž„
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        
        # ç¬¬äºŒæ­¥ï¼šç”ŸæˆåŸºç¡€é…ç½®
        make defconfig
        
        # ç¬¬ä¸‰æ­¥ï¼šæ‰‹åŠ¨ç¼–è¾‘.configæ–‡ä»¶ï¼Œç¡®ä¿åªé€‰ar71xx
        echo "æ‰‹åŠ¨ç¼–è¾‘é…ç½®ï¼Œç¡®ä¿åªé€‰ar71xx..."
        sed -i '/CONFIG_TARGET_/d' .config  # åˆ é™¤æ‰€æœ‰ç›®æ ‡é…ç½®
        sed -i '/CONFIG_TARGET_ARCH_PACKAGES/d' .config  # åˆ é™¤æž¶æž„åŒ…é…ç½®
        
        # é‡æ–°æ·»åŠ åªæˆ‘ä»¬éœ€è¦çš„é…ç½®
        echo "# åªé€‰ ar71xx" >> .config
        echo "CONFIG_TARGET_ar71xx=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        
        # ç¦ç”¨æ‰€æœ‰å…¶ä»–æž¶æž„
        echo "# ç¦ç”¨å…¶ä»–æ‰€æœ‰æž¶æž„" >> .config
        echo "# CONFIG_TARGET_x86 is not set" >> .config
        echo "# CONFIG_TARGET_x86_64 is not set" >> .config
        echo "# CONFIG_TARGET_armvirt is not set" >> .config
        echo "# CONFIG_TARGET_mediatek is not set" >> .config
        echo "# CONFIG_TARGET_ramips is not set" >> .config
        echo "# CONFIG_TARGET_bcm27xx is not set" >> .config
        echo "# CONFIG_TARGET_mxs is not set" >> .config
        echo "# CONFIG_TARGET_sunxi is not set" >> .config
        
        # åŸºæœ¬é…ç½®
        echo "# åŸºç¡€é…ç½®" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        
        echo "# åŸºç¡€åŒ…" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_BUSYBOX_CUSTOM=y" >> .config
        
        # æ— çº¿é©±åŠ¨
        echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
        echo "CONFIG_ATH_USER_REGD=y" >> .config
        
        echo "âœ… é…ç½®å¼ºåˆ¶å®Œæˆ"
        
    - name: Verify configuration
      run: |
        cd immortalwrt
        
        echo "ðŸ” éªŒè¯é…ç½®..."
        echo "æ£€æŸ¥æ˜¯å¦æœ‰ x86 ç›¸å…³é…ç½®ï¼š"
        grep -i "x86\|x86_64\|target-x86" .config 2>/dev/null && echo "âš ï¸ å‘çŽ°x86é…ç½®" || echo "âœ… æ— x86é…ç½®"
        
        echo "æ£€æŸ¥ç›®æ ‡æž¶æž„ï¼š"
        grep -i "target.*ar71xx\|target.*generic" .config
        
        echo "é…ç½®æ–‡ä»¶å¤§å°ï¼š"
        wc -l .config
        
    - name: Minimal build
      run: |
        cd immortalwrt
        
        echo "ðŸ”¨ å¼€å§‹æœ€å°åŒ–ç¼–è¯‘..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # åªç¼–è¯‘å†…æ ¸å’ŒåŸºç¡€åŒ…
        echo "1. ç¼–è¯‘å†…æ ¸..."
        make target/linux/compile -j$(nproc) 2>&1 | tee kernel-build.log
        
        echo "2. ç¼–è¯‘åŸºç¡€åŒ…..."
        make package/base-files/compile -j$(nproc) 2>&1 | tee base-build.log
        make package/busybox/compile -j$(nproc) 2>&1 | tee busybox-build.log
        
        echo "3. ç”Ÿæˆé•œåƒ..."
        make -j$(nproc) 2>&1 | tee final-build.log || {
          echo "âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          make -j1 2>&1 | tee single-build.log
        }
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Check results
      run: |
        cd immortalwrt
        
        echo "ðŸ“Š ç¼–è¯‘ç»“æžœæ£€æŸ¥..."
        
        # æ£€æŸ¥ar71xxç›®å½•æ˜¯å¦å­˜åœ¨
        if [ -d "bin/targets/ar71xx" ]; then
          echo "âœ… æ‰¾åˆ° ar71xx ç›®æ ‡ç›®å½•"
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          find bin/targets/ar71xx -type f -name "*.bin" 2>/dev/null | while read file; do
            echo "ðŸŽ¯ å›ºä»¶: $file"
            ls -lh "$file"
          done
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
          COUNT=$(find bin/targets/ar71xx -name "*.bin" 2>/dev/null | wc -l)
          echo "æ‰¾åˆ° $COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
        else
          echo "âŒ æœªæ‰¾åˆ° ar71xx ç›®å½•"
          echo "ðŸ“ æ‰€æœ‰ç›®æ ‡ç›®å½•:"
          find bin/targets -type d 2>/dev/null || echo "æ— ç›®æ ‡ç›®å½•"
        fi
        
    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-final-firmware
        path: |
          immortalwrt/bin/targets/ar71xx/generic/*.bin
        retention-days: 7
