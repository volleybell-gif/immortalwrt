name: Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python 3 environment
      run: |
        sudo apt update
        # å®‰è£… Python 3 å’Œå¿…è¦ä¾èµ–
        sudo apt install -y python3 python3-dev python3-pip python3-venv
        # è®¾ç½® python æŒ‡å‘ python3
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1
        # å®‰è£…ç¼–è¯‘ä¾èµ–
        sudo apt install -y build-essential git libncurses5-dev libssl-dev
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip wget curl
        sudo apt install -y gawk file time bc quilt libtool libtool-bin automake autoconf
        
    - name: Get ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git
        
    - name: Configure for TL-WR703N 16MB
      run: |
        cd immortalwrt
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡ä½¿ç”¨ Python 3
        export PYTHON=python3
        
        # åˆ›å»ºåŸºç¡€é…ç½®
        cat > .config << 'EOF'
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_BUSYBOX_CUSTOM=y
EOF
        
        # ç”Ÿæˆé»˜è®¤é…ç½®
        make defconfig
        
    - name: Build firmware
      run: |
        cd immortalwrt
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡ä½¿ç”¨ Python 3
        export PYTHON=python3
        
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # å¤šçº¿ç¨‹ç¼–è¯‘
        make -j$(nproc) V=s 2>&1 | tee build.log || {
          echo "ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          make -j1 V=sc 2>&1 | tee build-single.log
        }
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Check and upload firmware
      run: |
        cd immortalwrt
        
        echo "æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶ç”Ÿæˆ
        if ls bin/targets/ar71xx/generic/*.bin 1>/dev/null 2>&1; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          ls -lh bin/targets/ar71xx/generic/*.bin
          
          # ç‰¹åˆ«æ£€æŸ¥ squashfs-sysupgrade
          for file in bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin 2>/dev/null; do
            if [ -f "$file" ]; then
              echo "âœ… æ‰¾åˆ° squashfs-sysupgrade å›ºä»¶: $file"
              size=$(stat -c%s "$file")
              echo "ðŸ“ å¤§å°: $((size / 1024 / 1024))MB ($((size / 1024))KB)"
            fi
          done
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "ðŸ“ ç›®å½•å†…å®¹:"
          find bin/targets/ar71xx/generic/ -type f 2>/dev/null | head -20
        fi
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-16m-firmware
        path: |
          immortalwrt/bin/targets/ar71xx/generic/*.bin
        retention-days: 7
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/build-single.log
        retention-days: 7
