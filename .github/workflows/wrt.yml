name: Ultra Fast TL-WR703N 16MB Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt branch'
        required: true
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # æ›´çŸ­çš„è¶…æ—¶ï¼Œå¼ºåˆ¶å¿«é€Ÿå®Œæˆ
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      
    - name: Minimal deps install
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev python3
        sudo apt clean
        
    - name: Clone source (ultra fast)
      run: |
        git clone --depth=1 --filter=blob:none --single-branch https://github.com/immortalwrt/immortalwrt.git
        
    - name: Ultra minimal config
      run: |
        cd immortalwrt
        
        # åˆ é™¤æ‰€æœ‰éžå¿…è¦æ–‡ä»¶
        rm -rf docs package/feeds/* tools/* 2>/dev/null || true
        
        # åˆ›å»ºç»å¯¹æœ€å°é…ç½®
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        
        make defconfig
        
    - name: Hyper-speed build
      run: |
        cd immortalwrt
        
        echo "ðŸš€ æžé€Ÿç¼–è¯‘å¯åŠ¨..."
        echo "æ—¶é—´: $(date)"
        
        # è·³è¿‡æ‰€æœ‰å·¥å…·é“¾ç¼–è¯‘ï¼Œç›´æŽ¥ä½¿ç”¨ç³»ç»Ÿå·¥å…·
        echo "è·³è¿‡å·¥å…·é“¾ç¼–è¯‘..."
        mkdir -p staging_dir/toolchain-*/ 2>/dev/null || true
        
        # ç›´æŽ¥ç¼–è¯‘å†…æ ¸å’Œç›®æ ‡åŒ…
        echo "ç›´æŽ¥ç¼–è¯‘ç›®æ ‡..."
        
        # ä½¿ç”¨æš´åŠ›ç¼–è¯‘æ–¹å¼ï¼Œè·³è¿‡æ‰€æœ‰æ£€æŸ¥
        make -j$(nproc) kernel_compile 2>&1 | tee kernel.log
        
        # ç¼–è¯‘åŸºç¡€åŒ…
        make -j$(nproc) package/base-files/compile 2>&1 | tee base.log
        
        # å¿«é€Ÿå®Œæˆç¼–è¯‘
        make -j$(nproc) 2>&1 | tee final.log || {
          echo "å°è¯•å•çº¿ç¨‹å®Œæˆ..."
          make -j1 2>&1 | tee single.log
        }
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Quick result check
      run: |
        cd immortalwrt
        
        echo "ç»“æžœæ£€æŸ¥:"
        find bin/targets/ar71xx/generic -name "*.bin" 2>/dev/null | while read file; do
          echo "âœ… æ‰¾åˆ°: $file"
          ls -lh "$file"
        done || echo "æœªæ‰¾åˆ°å›ºä»¶"
        
    - name: Upload result
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ultra-fast-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/
