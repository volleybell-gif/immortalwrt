name: Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check disk space before build
      run: |
        echo "ğŸ“Š ç¼–è¯‘å‰ç£ç›˜ç©ºé—´æ£€æŸ¥:"
        df -h
        echo "å¯ç”¨å†…å­˜:"
        free -h
        
    - name: Setup minimal build environment
      run: |
        sudo apt update
        # åªå®‰è£…æœ€å¿…è¦çš„ä¾èµ–
        sudo apt install -y python3 python3-dev build-essential git libncurses5-dev libssl-dev
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        # æ¸…ç† apt ç¼“å­˜èŠ‚çœç©ºé—´
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        
    - name: Clone ImmortalWrt with minimal history
      run: |
        git clone --depth=1 --single-branch https://github.com/immortalwrt/immortalwrt.git
        
    - name: Configure for TL-WR703N 16MB
      run: |
        cd immortalwrt
        
        # æ¸…ç†ä¸€äº›ä¸å¿…è¦çš„ç›®å½•èŠ‚çœç©ºé—´
        rm -rf docs/ package/feeds/ tools/
        
        # åˆ›å»ºæœ€å°é…ç½®
        cat > .config << 'EOF'
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
EOF
        
        # åªé…ç½®ç›®æ ‡è®¾å¤‡ï¼Œä¸æ›´æ–°æ‰€æœ‰ feeds
        make defconfig
        
    - name: Build only target files
      run: |
        cd immortalwrt
        
        echo "ğŸ“Š ç¼–è¯‘å‰ç£ç›˜ç©ºé—´:"
        df -h
        
        export PYTHON=python3
        
        # åˆ†æ­¥ç¼–è¯‘ï¼ŒèŠ‚çœç©ºé—´
        echo "1. ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/install -j2
        
        echo "2. ç¼–è¯‘å†…æ ¸..."
        make target/linux/compile -j2
        
        echo "3. ç¼–è¯‘åŸºç¡€åŒ…..."
        make package/base-files/compile -j2
        make package/busybox/compile -j2
        
        echo "4. ç”Ÿæˆæœ€ç»ˆé•œåƒ..."
        make -j2
        
        echo "ğŸ“Š ç¼–è¯‘åç£ç›˜ç©ºé—´:"
        df -h
        
    - name: Clean up to save space before upload
      run: |
        cd immortalwrt
        
        echo "æ¸…ç†ä¸­é—´æ–‡ä»¶èŠ‚çœç©ºé—´..."
        # æ¸…ç†ç¼–è¯‘ä¸­é—´æ–‡ä»¶
        rm -rf build_dir/ staging_dir/ tmp/ logs/
        
        # åªä¿ç•™ ar71xx ç›¸å…³æ–‡ä»¶
        if [ -d "bin/targets" ]; then
          # åˆ é™¤å…¶ä»–æ¶æ„çš„æ–‡ä»¶
          find bin/targets -mindepth 1 -maxdepth 1 -type d ! -name 'ar71xx' -exec rm -rf {} + 2>/dev/null || true
          # æ¸…ç† packages
          rm -rf bin/packages 2>/dev/null || true
        fi
        
        echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
        df -h
        echo "å›ºä»¶å¤§å°:"
        du -sh bin/targets/ar71xx/generic/ || echo "æ— å›ºä»¶"
        
    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-16m-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/
        retention-days: 7
        
    - name: Upload disk info on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info
        path: |
          /home/runner/work/_temp/*.log
        retention-days: 1
