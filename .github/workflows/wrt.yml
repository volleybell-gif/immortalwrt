name: Fast Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt branch'
        required: true
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean
        
    - name: Clone source
      run: |
        git clone --depth=1 --single-branch https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.branch }}
        
    - name: Clean previous build only
      run: |
        cd immortalwrt
        
        echo "ðŸ§¹ ä»…æ¸…ç†ä¹‹å‰æž„å»ºçš„æ–‡ä»¶..."
        # åªæ¸…ç†æž„å»ºæ–‡ä»¶ï¼Œä¸åˆ é™¤å¿…è¦çš„ç›®å½•
        rm -rf bin build_dir staging_dir tmp logs .config 2>/dev/null || true
        
        echo "âœ… æ¸…ç†å®Œæˆ"
        
    - name: Configure minimal build
      run: |
        cd immortalwrt
        
        echo "ðŸŽ¯ åˆ›å»ºæœ€å°é…ç½®..."
        
        # åˆ›å»ºç»å¯¹æœ€å°é…ç½®
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        
        echo "ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
    - name: Skip problematic tools compilation
      run: |
        cd immortalwrt
        
        echo "ðŸ”§ è·³è¿‡æœ‰é—®é¢˜çš„å·¥å…·ç¼–è¯‘..."
        
        # è·³è¿‡ä½†ä¸åˆ é™¤ tools/ ç›®å½•
        # åˆ›å»ºè™šå‡çš„ç¼–è¯‘æ ‡è®°ï¼Œé¿å…å®žé™…ç¼–è¯‘
        mkdir -p tools/erofs-utils/build_dir/host 2>/dev/null || true
        mkdir -p tools/padjffs2/build_dir/host 2>/dev/null || true
        mkdir -p tools/quilt/build_dir/host 2>/dev/null || true
        mkdir -p tools/mpc/build_dir/host 2>/dev/null || true
        
        # æ ‡è®°ä¸ºå·²ç¼–è¯‘
        touch tools/erofs-utils/stamp-compile 2>/dev/null || true
        touch tools/padjffs2/stamp-compile 2>/dev/null || true
        touch tools/quilt/stamp-compile 2>/dev/null || true
        touch tools/mpc/stamp-compile 2>/dev/null || true
        
        echo "âœ… å·¥å…·è·³è¿‡è®¾ç½®å®Œæˆ"
        
    - name: Fast compile with workarounds
      run: |
        cd immortalwrt
        
        echo "âš¡ å¼€å§‹å¿«é€Ÿç¼–è¯‘..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo ""
        echo "ðŸš€ å…¨é€Ÿç¼–è¯‘å¼€å§‹..."
        
        # åˆ†é˜¶æ®µç¼–è¯‘ï¼Œä½†ä½¿ç”¨æœ€å¤§çº¿ç¨‹
        # é˜¶æ®µ1ï¼šå·¥å…·é“¾ï¼ˆå•çº¿ç¨‹é¿å…ä¾èµ–é—®é¢˜ï¼‰
        echo "é˜¶æ®µ1: å·¥å…·é“¾ç¼–è¯‘ (å•çº¿ç¨‹)"
        make toolchain/install -j1 V=s 2>&1 | tee stage1.log
        
        # é˜¶æ®µ2ï¼šå†…æ ¸ï¼ˆå¤šçº¿ç¨‹ï¼‰
        echo "é˜¶æ®µ2: å†…æ ¸ç¼–è¯‘"
        make target/linux/compile -j$(nproc) V=sc 2>&1 | tee stage2.log
        
        # é˜¶æ®µ3ï¼šåŸºç¡€åŒ…ï¼ˆå¤šçº¿ç¨‹ï¼‰
        echo "é˜¶æ®µ3: åŸºç¡€åŒ…ç¼–è¯‘"
        make package/base-files/compile -j$(nproc) V=sc 2>&1 | tee stage3.log
        make package/busybox/compile -j$(nproc) V=sc 2>&1 | tee stage4.log
        
        # é˜¶æ®µ4ï¼šæœ€ç»ˆç¼–è¯‘ï¼ˆå¤šçº¿ç¨‹ï¼‰
        echo "é˜¶æ®µ4: æœ€ç»ˆç¼–è¯‘"
        make -j$(nproc) V=s 2>&1 | tee build.log || {
          echo "âš ï¸ å¤šçº¿ç¨‹å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          make -j1 V=sc 2>&1 | tee build-single.log
        }
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Check for firmware
      run: |
        cd immortalwrt
        
        echo "ðŸ” æ£€æŸ¥å›ºä»¶..."
        
        if find bin/targets -name "*.bin" 2>/dev/null | grep -q .; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼æ‰¾åˆ°å›ºä»¶:"
          find bin/targets -name "*.bin" -exec ls -lh {} \;
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶"
          echo "ðŸ“ æŸ¥çœ‹ build_dir å†…å®¹:"
          ls -la build_dir/ 2>/dev/null | head -5 || echo "æ—  build_dir"
          echo "ðŸ“ æŸ¥çœ‹ staging_dir å†…å®¹:"
          ls -la staging_dir/ 2>/dev/null | head -5 || echo "æ—  staging_dir"
        fi
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/*.bin
        retention-days: 7
