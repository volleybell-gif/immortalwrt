name: Fast Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt branch'
        required: true
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean
        
    - name: Clone source
      run: |
        git clone --depth=1 --single-branch https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.branch }}
        
    - name: Clean and configure for MIPS only
      run: |
        cd immortalwrt
        
        echo "ðŸ§¹ æ¸…ç†ä¹‹å‰æž„å»ºçš„æ–‡ä»¶..."
        make clean 2>/dev/null || true
        rm -rf bin build_dir staging_dir tmp logs .config 2>/dev/null || true
        
        echo "ðŸŽ¯ å¼ºåˆ¶è®¾ç½®ä¸º MIPS/ar71xx æž¶æž„..."
        
        # ä½¿ç”¨å¤šä¸ªechoå‘½ä»¤ï¼Œé¿å…å¤šè¡Œå­—ç¬¦ä¸²é—®é¢˜
        echo "# ç›®æ ‡æž¶æž„ - åªé€‰ ar71xx" > .config
        echo "CONFIG_TARGET_ar71xx=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "# æ˜Žç¡®ç¦ç”¨ x86 å’Œå…¶ä»–æž¶æž„" >> .config
        echo "CONFIG_TARGET_x86=n" >> .config
        echo "CONFIG_TARGET_x86_64=n" >> .config
        echo "CONFIG_TARGET_armvirt=n" >> .config
        echo "CONFIG_TARGET_mediatek=n" >> .config
        echo "CONFIG_TARGET_ramips=n" >> .config
        echo "CONFIG_TARGET_bcm27xx=n" >> .config
        echo "CONFIG_TARGET_mxs=n" >> .config
        echo "CONFIG_TARGET_sunxi=n" >> .config
        echo "# 16MBé—ªå­˜é…ç½®" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "# åŸºç¡€ç³»ç»Ÿ" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_BUSYBOX_CUSTOM=y" >> .config
        echo "# æ ¸å¿ƒåº“" >> .config
        echo "CONFIG_PACKAGE_libc=y" >> .config
        echo "CONFIG_PACKAGE_libgcc=y" >> .config
        echo "CONFIG_PACKAGE_libpthread=y" >> .config
        echo "# ç³»ç»ŸæœåŠ¡" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "# ç½‘ç»œåŸºç¡€" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "# æ— çº¿é©±åŠ¨" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
        echo "CONFIG_ATH_USER_REGD=y" >> .config
        echo "# ç¦ç”¨ä¸å¿…è¦çš„åŒ…" >> .config
        echo "CONFIG_PACKAGE_emortal_default-settings=n" >> .config
        echo "CONFIG_PACKAGE_luci=n" >> .config
        echo "CONFIG_PACKAGE_uhttpd=n" >> .config
        echo "CONFIG_PACKAGE_grub2=n" >> .config
        
        echo "ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
        # ç¡®ä¿ x86 ç›®æ ‡è¢«ç¦ç”¨
        sed -i 's/CONFIG_TARGET_x86=y/# CONFIG_TARGET_x86 is not set/' .config 2>/dev/null || true
        sed -i 's/CONFIG_TARGET_x86_64=y/# CONFIG_TARGET_x86_64 is not set/' .config 2>/dev/null || true
        
        echo "âœ… æž¶æž„é…ç½®å®Œæˆ"
        
    - name: Build only MIPS target
      run: |
        cd immortalwrt
        
        echo "âš¡ å¼€å§‹ç¼–è¯‘ MIPS å›ºä»¶..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶åªç¼–è¯‘ ar71xx
        export CONFIG_TARGET_ar71xx=y
        export CONFIG_TARGET_x86=n
        export CONFIG_TARGET_x86_64=n
        
        echo ""
        echo "ðŸš€ å…¨é€Ÿç¼–è¯‘..."
        
        # ç¼–è¯‘å‘½ä»¤ - å…¨é€Ÿä½†ç¡®ä¿æ­£ç¡®
        make -j$(nproc) V=s 2>&1 | tee build.log || {
          echo "âš ï¸ å¤šçº¿ç¨‹å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          make -j1 V=sc 2>&1 | tee build-single.log
        }
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Check for ar71xx firmware
      run: |
        cd immortalwrt
        
        echo "ðŸ” æ£€æŸ¥ MIPS/ar71xx å›ºä»¶..."
        
        if [ -d "bin/targets/ar71xx/generic" ]; then
          echo "âœ… æ‰¾åˆ° ar71xx ç›®å½•"
          
          if ls bin/targets/ar71xx/generic/*.bin 1>/dev/null 2>&1; then
            echo "ðŸŽ‰ ç¼–è¯‘æˆåŠŸï¼å›ºä»¶æ–‡ä»¶:"
            ls -lh bin/targets/ar71xx/generic/*.bin
            
            # ç‰¹åˆ«æ£€æŸ¥ squashfs-sysupgrade
            for f in bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin 2>/dev/null; do
              if [ -f "$f" ]; then
                echo "ðŸŽ¯ æ‰¾åˆ° squashfs-sysupgrade å›ºä»¶: $(basename "$f")"
                size=$(stat -c%s "$f")
                echo "ðŸ“ å¤§å°: $((size / 1024 / 1024))MB"
              fi
            done
          else
            echo "âš ï¸ ar71xx ç›®å½•ä¸‹æ²¡æœ‰ .bin æ–‡ä»¶"
            ls -la bin/targets/ar71xx/generic/ 2>/dev/null || echo "æ— æ³•è®¿é—®ç›®å½•"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ° ar71xx ç›®å½•"
          echo "ðŸ“ æŸ¥æ‰¾å…¶ä»–ç›®æ ‡:"
          find bin/targets -type d 2>/dev/null | head -10
        fi
        
    - name: Upload MIPS firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-mips-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/*.bin
        retention-days: 7
