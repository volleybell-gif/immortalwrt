name: Fast Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt branch'
        required: true
        default: 'openwrt-21.02'
      use_ccache:
        description: 'ä½¿ç”¨CCacheåŠ é€Ÿ'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # ç¼©çŸ­è¶…æ—¶æ—¶é—´
    
    strategy:
      matrix:
        threads: [4]  # é»˜è®¤ä½¿ç”¨4çº¿ç¨‹ï¼ŒGitHub Actionsé€šå¸¸æ˜¯4æ ¸
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup CCache for maximum speed
      if: ${{ github.event.inputs.use_ccache == 'true' }}
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.sha }}
        max-size: 2G
        
    - name: Install fastest build environment
      run: |
        sudo apt update
        # å¿«é€Ÿå®‰è£…ï¼Œæœ€å°ä¾èµ–
        sudo apt install -y build-essential ccache git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean
        
    - name: Clone source with fast mirror
      run: |
        # ä½¿ç”¨å¿«é€Ÿå…‹éš†ï¼Œè·³è¿‡åŽ†å²
        git clone --depth=1 --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.branch }}
        
    - name: Prepare fast configuration
      run: |
        cd immortalwrt
        
        echo "ðŸ”¥ é…ç½®æžé€Ÿç¼–è¯‘çŽ¯å¢ƒ..."
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡åŠ é€Ÿ
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_MAXSIZE=2G
        
        # å¯ç”¨CCache
        sed -i 's/# CONFIG_CCACHE is not set/CONFIG_CCACHE=y/' .config 2>/dev/null || true
        
        # åˆ›å»ºæœ€å°ä½†å®Œæ•´çš„é…ç½®
        cat > .config << 'EOF'
# ç›®æ ‡è®¾å¤‡
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y

# 16MBé—ªå­˜é…ç½®
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y

# åŸºç¡€ç³»ç»Ÿï¼ˆå¿…é¡»ï¼‰
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_BUSYBOX_CUSTOM=y
CONFIG_BUSYBOX_CONFIG_FEATURE_USE_INITTAB=y

# æ ¸å¿ƒåº“ï¼ˆé¿å…ç¼–è¯‘å¤±è´¥ï¼‰
CONFIG_PACKAGE_libc=y
CONFIG_PACKAGE_libgcc=y
CONFIG_PACKAGE_libpthread=y
CONFIG_PACKAGE_libubox=y
CONFIG_PACKAGE_libubus=y
CONFIG_PACKAGE_libuci=y

# ç³»ç»ŸæœåŠ¡
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_ubox=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_logd=y

# ç½‘ç»œåŸºç¡€
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y

# æ— çº¿é©±åŠ¨
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_ATH_USER_REGD=y

# å†…æ ¸æ¨¡å—
CONFIG_PACKAGE_kmod-nls-base=y
CONFIG_PACKAGE_kmod-ipv6=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-conntrack=y

# ç¦ç”¨æœ‰é—®é¢˜çš„åŒ…
CONFIG_PACKAGE_emortal_default-settings=n
CONFIG_PACKAGE_luci=n
CONFIG_PACKAGE_uhttpd=n

# æ€§èƒ½ä¼˜åŒ–
CONFIG_CCACHE=y
CONFIG_KERNEL_KALLSYMS=n
CONFIG_KERNEL_DEBUG_INFO=n
CONFIG_KERNEL_DEBUG_KERNEL=n
EOF
        
        make defconfig
        
    - name: Fast parallel build
      run: |
        cd immortalwrt
        
        echo "âš¡ å¼€å§‹å…¨é€Ÿç¼–è¯‘..."
        echo "========================================"
        echo "ç³»ç»Ÿä¿¡æ¯:"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        echo "å†…å­˜: $(free -h | awk '/Mem:/ {print $2}')"
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "ç¼–è¯‘çº¿ç¨‹æ•°: ${{ matrix.threads }}"
        echo "========================================"
        
        # è®¾ç½®æ€§èƒ½ä¼˜åŒ–çŽ¯å¢ƒå˜é‡
        export MAKE_JOBS=${{ matrix.threads }}
        export FORCE_UNSAFE_CONFIGURE=1
        
        # ä½¿ç”¨ä¼˜åŒ–çš„å¹¶è¡Œç¼–è¯‘
        echo ""
        echo "ðŸ”§ ä½¿ç”¨ä¼˜åŒ–ç¼–è¯‘å‚æ•°..."
        
        # å…³é”®ä¼˜åŒ–ï¼šè·³è¿‡ç‰¹å®šå·¥å…·ç¼–è¯‘ï¼Œä½¿ç”¨å·²æœ‰çš„
        echo "è·³è¿‡éƒ¨åˆ†å·¥å…·ç¼–è¯‘ä»¥åŠ é€Ÿ..."
        mkdir -p tools/erofs-utils/build_dir/host
        mkdir -p tools/padjffs2/build_dir/host
        mkdir -p tools/quilt/build_dir/host
        touch tools/erofs-utils/stamp-compile 2>/dev/null || true
        touch tools/padjffs2/stamp-compile 2>/dev/null || true
        touch tools/quilt/stamp-compile 2>/dev/null || true
        
        # å…¨é€Ÿç¼–è¯‘å‘½ä»¤
        echo "æ‰§è¡Œå…¨é€Ÿç¼–è¯‘..."
        
        # æ–¹æ³•1ï¼šå¹¶è¡Œç¼–è¯‘æ‰€æœ‰ï¼ˆæœ€å¿«ï¼‰
        make -j${{ matrix.threads }} V=sc 2>&1 | tee fast-build.log || {
          echo "âš ï¸ å…¨é€Ÿç¼–è¯‘å¤±è´¥ï¼Œå°è¯•åˆ†æ­¥ç¼–è¯‘..."
          
          # æ–¹æ³•2ï¼šåˆ†æ­¥ä½†å¹¶è¡Œç¼–è¯‘
          echo "æ­¥éª¤1: å·¥å…·é“¾"
          make toolchain/compile -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤2: å†…æ ¸"
          make target/linux/compile -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤3: åŸºç¡€åŒ…"
          make package/base-files/compile -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log
          make package/busybox/compile -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤4: ç½‘ç»œåŒ…"
          make package/dnsmasq/compile -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log
          make package/firewall/compile -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤5: æ— çº¿é©±åŠ¨"
          make package/kmod-ath9k/compile -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤6: æœ€ç»ˆç¼–è¯‘"
          make -j${{ matrix.threads }} 2>&1 | tee -a fast-build.log || {
            echo "âš ï¸ æœ€ç»ˆæ­¥éª¤å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make -j1 2>&1 | tee -a fast-build.log
          }
        }
        
        echo "========================================"
        echo "å®Œæˆæ—¶é—´: $(date)"
        echo "æ€»ç¼–è¯‘æ—¶é—´: $SECONDS ç§’"
        
    - name: Quick firmware check
      run: |
        cd immortalwrt
        
        echo "ðŸ” å¿«é€Ÿæ£€æŸ¥å›ºä»¶..."
        
        # å¿«é€ŸæŸ¥æ‰¾å›ºä»¶
        if ls bin/targets/ar71xx/generic/*.bin 1>/dev/null 2>&1; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼æ‰¾åˆ°å›ºä»¶:"
          ls -lh bin/targets/ar71xx/generic/*.bin | head -5
          
          # æ£€æŸ¥æ˜¯å¦æœ‰squashfs-sysupgrade
          SQUASHFS_FILE=$(find bin/targets/ar71xx/generic -name "*squashfs-sysupgrade*.bin" 2>/dev/null | head -1)
          if [ -n "$SQUASHFS_FILE" ]; then
            echo "ðŸŽ¯ æ‰¾åˆ° squashfs-sysupgrade å›ºä»¶"
            ls -lh "$SQUASHFS_FILE"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "å°è¯•æŸ¥æ‰¾å…¶ä»–æ–‡ä»¶..."
          find bin/targets/ar71xx/generic -type f 2>/dev/null | head -10 || echo "æ— æ–‡ä»¶"
        fi
        
    - name: Upload fast firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-fast-firmware
        path: |
          immortalwrt/bin/targets/ar71xx/generic/*.bin
        retention-days: 7
        
    - name: Upload quick build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fast-build-logs
        path: |
          immortalwrt/fast-build.log
        retention-days: 3
