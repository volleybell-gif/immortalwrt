name: Build ImmortalWrt TL-WR703N 16MB (Optimized)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt branch version'
        required: true
        default: 'openwrt-21.02'
      skip_tools:
        description: 'è·³è¿‡å·¥å…·é“¾ç¼–è¯‘ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # ç¼©çŸ­è¶…æ—¶æ—¶é—´

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup cache for toolchain
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          immortalwrt/dl
          immortalwrt/staging_dir
        key: ${{ runner.os }}-openwrt-toolchain-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-toolchain-

    - name: Setup minimal build environment
      run: |
        sudo apt update
        # åªå®‰è£…ç»å¯¹å¿…è¦çš„åŒ…
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean

    - name: Clone ImmortalWrt with specified branch
      run: |
        git clone --depth=1 --single-branch https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.branch }}

    - name: Setup monitoring script
      run: |
        # åˆ›å»ºç›‘æ§è„šæœ¬
        cat > monitor_build.sh << 'EOF'
        #!/bin/bash
        echo "ğŸ• å¼€å§‹ç›‘æ§ç¼–è¯‘è¿‡ç¨‹..."
        echo "æ—¶é—´æˆ³: $(date)"
        echo "CPUä½¿ç”¨æƒ…å†µ:"
        top -bn1 | grep "Cpu(s)"
        echo ""
        echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:"
        free -h
        echo ""
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h .
        echo ""
        echo "å½“å‰è¿è¡Œçš„ç¼–è¯‘è¿›ç¨‹:"
        ps aux | grep -E "make|gcc|g++" | grep -v grep | head -10
        EOF
        chmod +x monitor_build.sh

    - name: Configure for TL-WR703N 16MB
      run: |
        cd immortalwrt
        
        # åˆ›å»ºæœ€å°é…ç½®ï¼Œè·³è¿‡ä¸éœ€è¦çš„å·¥å…·
        cat > .config << 'EOF'
# Target System
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y

# 16MB Flash Configuration
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y

# ç¦ç”¨ä¸å¿…è¦çš„å¤§å‹å·¥å…·ç¼–è¯‘
CONFIG_BUILD_TOOLCHAIN=n
CONFIG_CCACHE=y

# åŸºç¡€ç³»ç»Ÿ
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_BUSYBOX_CUSTOM=y

# ç½‘ç»œåŸºç¡€
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y

# æ— çº¿
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_ATH_USER_REGD=y

# ç³»ç»ŸæœåŠ¡
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_uci=y
EOF

        make defconfig

    - name: Build with optimization and monitoring
      run: |
        cd immortalwrt
        
        # è®¾ç½®ç¯å¢ƒå˜é‡åŠ é€Ÿç¼–è¯‘
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_MAXSIZE=2G
        export MAKE_JOBS=$(nproc)
        
        echo "ğŸ”§ ç¼–è¯‘ç¯å¢ƒä¿¡æ¯:"
        echo "- CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "- å†…å­˜: $(free -h | awk '/Mem:/ {print $2}')"
        echo "- ç£ç›˜ç©ºé—´: $(df -h . | awk 'NR==2 {print $4}')"
        
        echo ""
        echo "ğŸš€ å¼€å§‹ç¼–è¯‘..."
        
        # åˆ†æ­¥éª¤ç¼–è¯‘ï¼Œæ¯ä¸€æ­¥éƒ½ç›‘æ§
        for step in defconfig toolchain/install target/linux/install package/base-files/install package/busybox/install; do
          echo ""
          echo "========================================"
          echo "æ­£åœ¨æ‰§è¡Œ: make $step"
          echo "å¼€å§‹æ—¶é—´: $(date +%H:%M:%S)"
          
          # è¿è¡Œç›‘æ§è„šæœ¬
          ../monitor_build.sh
          
          # æ‰§è¡Œç¼–è¯‘æ­¥éª¤
          timeout 300 make -j$(nproc) $step 2>&1 | tee -a build.log || {
            echo "âš ï¸ æ­¥éª¤ '$step' è¶…æ—¶æˆ–å¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ­¥éª¤..."
          }
          
          echo "å®Œæˆæ—¶é—´: $(date +%H:%M:%S)"
        done
        
        echo ""
        echo "========================================"
        echo "ğŸ¯ å¼€å§‹æœ€ç»ˆç¼–è¯‘..."
        echo "å¼€å§‹æ—¶é—´: $(date +%H:%M:%S)"
        
        # æœ€ç»ˆç¼–è¯‘ï¼Œå¸¦è¶…æ—¶
        timeout 1800 make -j$(nproc) 2>&1 | tee -a build.log || {
          echo "âš ï¸ æœ€ç»ˆç¼–è¯‘å¯èƒ½æœªå®Œæˆï¼Œæ£€æŸ¥è¾“å‡º..."
        }
        
        echo "å®Œæˆæ—¶é—´: $(date +%H:%M:%S)"

    - name: Analyze build performance
      if: always()
      run: |
        echo "ğŸ“Š ç¼–è¯‘æ€§èƒ½åˆ†æ:"
        echo ""
        echo "1. æ€»ç¼–è¯‘æ—¶é—´:"
        echo "   å¼€å§‹: $(date -d @$(stat -c%Y immortalwrt/build.log 2>/dev/null || echo 0) 2>/dev/null || echo 'N/A')"
        echo "   ç»“æŸ: $(date)"
        echo ""
        echo "2. ç¼–è¯‘æ­¥éª¤è€—æ—¶åˆ†æ:"
        if [ -f immortalwrt/build.log ]; then
          echo "   ç¼–è¯‘æ­¥éª¤ç»Ÿè®¡:"
          grep -E "(æ­£åœ¨æ‰§è¡Œ|å¼€å§‹æ—¶é—´|å®Œæˆæ—¶é—´)" build.log || echo "   æ— è¯¦ç»†æ—¥å¿—"
        fi
        echo ""
        echo "3. ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ç“¶é¢ˆ:"
        echo "   æŸ¥çœ‹å“ªäº›æ­¥éª¤æœ€è€—æ—¶:"
        if [ -f immortalwrt/build.log ]; then
          echo "   - å·¥å…·é“¾ç¼–è¯‘: $(grep -c "tools/" immortalwrt/build.log || echo 0) ä¸ªå·¥å…·"
          echo "   - å†…æ ¸ç¼–è¯‘: $(grep -c "kernel/" immortalwrt/build.log || echo 0) ä¸ªæ¨¡å—"
          echo "   - åŒ…ç¼–è¯‘: $(grep -c "package/" immortalwrt/build.log || echo 0) ä¸ªåŒ…"
        fi

    - name: Upload firmware and logs
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-build-results
        path: |
          immortalwrt/bin/targets/ar71xx/generic/*.bin
          immortalwrt/build.log
          monitor_build.sh
        retention-days: 7
