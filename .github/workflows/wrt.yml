name: Build ImmortalWrt 21.02 for WR703N

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build (no cache)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [main]
    paths:
      - '.github/workflows/build-immortalwrt.yml'
      - 'config/**'
      - 'feeds.conf'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  TARGET: ath79
  SUBTARGET: tiny
  PROFILE: tl-wr703n-v1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev \
          xmlto \
          quilt \
          rename

    - name: Setup ccache
      uses: actions/cache@v3
      with:
        path: ~/.ccache
        key: ccache-${{ github.sha }}
        restore-keys: |
          ccache-

    - name: Cache download directory
      uses: actions/cache@v3
      with:
        path: dl
        key: dl-cache-${{ hashFiles('feeds.conf', 'Makefile') }}
        restore-keys: |
          dl-cache-

    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        if [ -f ../feeds.conf ]; then
          cp ../feeds.conf .
        fi

    - name: Update and install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure for WR703N 16M
      run: |
        cd openwrt
        
        # 生成基础配置
        cat > .config << 'EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ATH79_TINY=y
CONFIG_TARGET_ATH79_TINY_DEVICE_TL_WR703N_V1=y
CONFIG_TARGET_ROOTFS_PARTSIZE=15360
CONFIG_TARGET_KERNEL_PARTSIZE=4
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_kmod-ipt-offload=y
CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_e2fsprogs=y
CONFIG_BINARY_FOLDER=""
CONFIG_DOWNLOAD_FOLDER=""
CONFIG_LOCALMIRROR=""
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
EOF

        # 应用配置
        make defconfig

    - name: Download packages
      run: |
        cd openwrt
        make download -j$(nproc)

    - name: Build firmware
      run: |
        cd openwrt
        
        # 设置环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR="$HOME/.ccache"
        export CCACHE_MAXSIZE=5G
        export CCACHE_COMPRESS=1
        export CCACHE_COMPRESSLEVEL=6
        
        # 清理或使用缓存构建
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "Performing clean build..."
          make clean
        fi
        
        # 开始编译（使用所有CPU核心）
        time make -j$(nproc) V=s

    - name: List generated files
      run: |
        cd openwrt
        echo "=== Generated firmware files ==="
        find bin/targets -type f -name "*.bin" | xargs ls -lh
        echo ""
        echo "=== Sysupgrade files ==="
        find bin/targets -type f -name "*sysupgrade*.bin" | xargs ls -lh

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: immortalwrt-21.02-wr703n-16m
        path: |
          openwrt/bin/targets/ath79/tiny/*.bin
          openwrt/bin/targets/ath79/tiny/*.manifest
        retention-days: 7

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          openwrt/logs/
          openwrt/build.log
        retention-days: 3
