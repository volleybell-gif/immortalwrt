
name: Build ImmortalWrt for TP-WR703N

on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'  # 每周日凌晨2点自动编译

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  TARGET: ath79
  SUBTARGET: tiny
  PROFILE: tp-link_tl-wr703n-v1

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - device: tp-link_tl-wr703n-v1
            packages: ""
            
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      uses: docker/setup-buildx-action@v3
      
    - name: Cache build directories
      uses: actions/cache@v4
      with:
        path: |
          openwrt/dl
          openwrt/build_dir
          openwrt/staging_dir
          openwrt/tmp
        key: ${{ runner.os }}-immortalwrt-${{ env.REPO_BRANCH }}-${{ hashFiles('**/.config') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-${{ env.REPO_BRANCH }}-
          
    - name: Checkout ImmortalWrt source
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        
    - name: Prepare build configuration
      run: |
        cd openwrt
        # 生成默认配置
        make defconfig
        # 设置目标设备
        echo "CONFIG_TARGET_ath79=y" >> .config
        echo "CONFIG_TARGET_ath79_tiny=y" >> .config
        echo "CONFIG_TARGET_ath79_tiny_DEVICE_tp-link_tl-wr703n-v1=y" >> .config
        # 设置16MB闪存
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=512" >> .config
        # 启用 squashfs-sysupgrade
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        # 启用多线程编译
        echo "CONFIG_BUILD_SUFFIX=\"\"" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        # 更新配置
        make defconfig
        
    - name: Build firmware
      run: |
        cd openwrt
        # 获取CPU核心数用于多线程编译
        CPU_CORES=$(nproc)
        # 使用多线程编译，启用ccache缓存加速
        make -
