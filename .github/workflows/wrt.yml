name: Stable TL-WR703N 16MB Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean
        
    - name: Clone fresh source
      run: |
        # å®Œå…¨é‡æ–°å¼€å§‹
        rm -rf immortalwrt 2>/dev/null || true
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git
        
    - name: Update and install feeds (å…³é”®æ­¥éª¤)
      run: |
        cd immortalwrt
        
        echo "ğŸ”„ æ›´æ–°feeds..."
        
        # æ£€æŸ¥feedsé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "feeds.conf.default" ]; then
          echo "âš ï¸ feeds.conf.default ä¸å­˜åœ¨ï¼Œå°è¯•æ¢å¤..."
          # ä»gitæ¢å¤æ–‡ä»¶
          git checkout feeds.conf.default 2>/dev/null || {
            echo "âŒ æ— æ³•æ¢å¤feeds.conf.default"
            exit 1
          }
        fi
        
        echo "æ­£åœ¨æ›´æ–°feeds..."
        ./scripts/feeds update -a
        
        echo "å®‰è£…feeds..."
        ./scripts/feeds install -a
        
        echo "âœ… Feeds æ›´æ–°å®Œæˆ"
        
    - name: Configure minimal build
      run: |
        cd immortalwrt
        
        echo "ğŸ¯ åˆ›å»ºæœ€å°é…ç½®..."
        
        # åªæ¸…ç†æ„å»ºç›®å½•ï¼Œä¸è¦åˆ é™¤é…ç½®æ–‡ä»¶
        rm -rf bin build_dir staging_dir tmp logs .config 2>/dev/null || true
        
        # åˆ›å»ºæœ€å°é…ç½®
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_BUSYBOX_CUSTOM=y" >> .config
        
        # ç¦ç”¨æ‰€æœ‰å…¶ä»–æ¶æ„
        echo "# ç¦ç”¨x86å’Œå…¶ä»–æ¶æ„" >> .config
        echo "# CONFIG_TARGET_x86 is not set" >> .config
        echo "# CONFIG_TARGET_x86_64 is not set" >> .config
        
        echo "ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
        # ç¡®ä¿åªç¼–è¯‘ar71xx
        sed -i 's/CONFIG_TARGET_x86=y/# CONFIG_TARGET_x86 is not set/' .config 2>/dev/null || true
        sed -i 's/CONFIG_TARGET_x86_64=y/# CONFIG_TARGET_x86_64 is not set/' .config 2>/dev/null || true
        
        echo "âœ… é…ç½®å®Œæˆ"
        
    - name: Build with optimization
      run: |
        cd immortalwrt
        
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export FORCE_UNSAFE_CONFIGURE=1
        
        # ç¼–è¯‘æ­¥éª¤
        echo "1. ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/install -j$(nproc) 2>&1 | tee toolchain.log || {
          echo "âš ï¸ å·¥å…·é“¾ç¼–è¯‘å‡ºç°é—®é¢˜ï¼Œç»§ç»­..."
        }
        
        echo "2. ç¼–è¯‘å†…æ ¸..."
        make target/linux/compile -j$(nproc) 2>&1 | tee kernel.log
        
        echo "3. ç¼–è¯‘åŸºç¡€åŒ…..."
        make package/base-files/compile -j$(nproc) 2>&1 | tee base.log
        make package/busybox/compile -j$(nproc) 2>&1 | tee busybox.log
        
        echo "4. æœ€ç»ˆç¼–è¯‘..."
        make -j$(nproc) 2>&1 | tee build.log || {
          echo "âš ï¸ å¤šçº¿ç¨‹å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
          make -j1 2>&1 | tee single.log
        }
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Check results
      run: |
        cd immortalwrt
        
        echo "ğŸ“Š ç¼–è¯‘ç»“æœæ£€æŸ¥..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶
        if find bin/targets -name "*.bin" 2>/dev/null | grep -q .; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼æ‰¾åˆ°å›ºä»¶:"
          find bin/targets -name "*.bin" -exec ls -lh {} \;
          
          # ç‰¹åˆ«æ£€æŸ¥ ar71xx å›ºä»¶
          if ls bin/targets/ar71xx/generic/*.bin 1>/dev/null 2>&1; then
            echo "ğŸ¯ TL-WR703N 16MB å›ºä»¶:"
            ls -lh bin/targets/ar71xx/generic/*.bin | head -3
            
            # æ£€æŸ¥å›ºä»¶ç±»å‹
            for f in bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin 2>/dev/null; do
              if [ -f "$f" ]; then
                echo "ğŸ‰ æ‰¾åˆ° squashfs-sysupgrade å›ºä»¶"
                size=$(stat -c%s "$f")
                echo "ğŸ“ å¤§å°: $((size / 1024 / 1024))MB ($((size / 1024))KB)"
              fi
            done
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "ğŸ“ ç›®å½•ç»“æ„:"
          ls -la bin/ 2>/dev/null || echo "bin/ ç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-16mb-firmware
        path: |
          immortalwrt/bin/targets/ar71xx/generic/*.bin
        retention-days: 7
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/single.log
        retention-days: 7
