name: Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y python3 python3-dev python3-pip
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1
        sudo apt install -y build-essential git libncurses5-dev libssl-dev
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip wget curl
        sudo apt install -y gawk file time bc quilt libtool libtool-bin automake autoconf
        
    - name: Get ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git
        
    - name: Configure build
      run: |
        cd immortalwrt
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
    - name: Build firmware
      run: |
        cd immortalwrt
        export PYTHON=python3
        make defconfig
        echo "Building with $(nproc) threads..."
        make -j$(nproc)
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/
