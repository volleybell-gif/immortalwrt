name: Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check disk space
      run: |
        echo "Disk space before build:"
        df -h
        free -h
        
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y python3 python3-dev build-essential git libncurses5-dev libssl-dev
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 --single-branch https://github.com/immortalwrt/immortalwrt.git
        
    - name: Configure for TL-WR703N 16MB
      run: |
        cd immortalwrt
        
        # 创建最小配置
        cat > .config << 'EOF'
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
EOF
        
    - name: Build step by step
      run: |
        cd immortalwrt
        
        echo "Step 1: Generate config"
        make defconfig
        
        echo "Step 2: Build toolchain"
        make toolchain/install -j$(nproc)
        
        echo "Step 3: Build target"
        make target/linux/compile -j$(nproc)
        
        echo "Step 4: Build packages"
        make package/base-files/compile -j$(nproc)
        make package/busybox/compile -j$(nproc)
        
        echo "Step 5: Final build"
        make -j$(nproc)
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/
