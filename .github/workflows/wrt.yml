name: Fast Build ImmortalWrt TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt branch'
        required: true
        default: 'openwrt-21.02'
      use_ccache:
        description: 'ä½¿ç”¨CCacheåŠ é€Ÿ'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup CCache for maximum speed
      if: ${{ github.event.inputs.use_ccache == 'true' }}
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.sha }}
        max-size: 2G
        
    - name: Install fastest build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache git libncurses5-dev libssl-dev python3
        sudo apt install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip
        sudo apt clean
        
    - name: Clone source with fast mirror
      run: |
        git clone --depth=1 --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.branch }}
        
    - name: Prepare fast configuration
      run: |
        cd immortalwrt
        
        echo "ðŸ”¥ é…ç½®æžé€Ÿç¼–è¯‘çŽ¯å¢ƒ..."
        
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_MAXSIZE=2G
        
        # åˆ›å»ºæœ€å°é…ç½®ï¼Œç¦ç”¨ GRUB2
        echo "# ç›®æ ‡è®¾å¤‡" > .config
        echo "CONFIG_TARGET_ar71xx=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "# 16MBé—ªå­˜é…ç½®" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14080" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "# åŸºç¡€ç³»ç»Ÿï¼ˆå¿…é¡»ï¼‰" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_BUSYBOX_CUSTOM=y" >> .config
        echo "CONFIG_BUSYBOX_CONFIG_FEATURE_USE_INITTAB=y" >> .config
        echo "# æ ¸å¿ƒåº“ï¼ˆé¿å…ç¼–è¯‘å¤±è´¥ï¼‰" >> .config
        echo "CONFIG_PACKAGE_libc=y" >> .config
        echo "CONFIG_PACKAGE_libgcc=y" >> .config
        echo "CONFIG_PACKAGE_libpthread=y" >> .config
        echo "CONFIG_PACKAGE_libubox=y" >> .config
        echo "CONFIG_PACKAGE_libubus=y" >> .config
        echo "CONFIG_PACKAGE_libuci=y" >> .config
        echo "# ç³»ç»ŸæœåŠ¡" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_ubox=y" >> .config
        echo "CONFIG_PACKAGE_ubus=y" >> .config
        echo "CONFIG_PACKAGE_ubusd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config
        echo "CONFIG_PACKAGE_logd=y" >> .config
        echo "# ç½‘ç»œåŸºç¡€" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "# æ— çº¿é©±åŠ¨" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
        echo "CONFIG_ATH_USER_REGD=y" >> .config
        echo "# å†…æ ¸æ¨¡å—" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-base=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipv6=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-conntrack=y" >> .config
        echo "# ç¦ç”¨æœ‰é—®é¢˜çš„åŒ…" >> .config
        echo "CONFIG_PACKAGE_emortal_default-settings=n" >> .config
        echo "CONFIG_PACKAGE_luci=n" >> .config
        echo "CONFIG_PACKAGE_uhttpd=n" >> .config
        echo "CONFIG_PACKAGE_grub2=n" >> .config  # ç¦ç”¨ GRUB2
        echo "CONFIG_GRUB2=n" >> .config
        echo "CONFIG_GRUB2_EFI=n" >> .config
        echo "# æ€§èƒ½ä¼˜åŒ–" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_KERNEL_KALLSYMS=n" >> .config
        echo "CONFIG_KERNEL_DEBUG_INFO=n" >> .config
        echo "CONFIG_KERNEL_DEBUG_KERNEL=n" >> .config
        
        make defconfig
        
        # å†æ¬¡ç¡®è®¤ç¦ç”¨ GRUB2
        sed -i 's/CONFIG_PACKAGE_grub2=y/# CONFIG_PACKAGE_grub2 is not set/' .config
        sed -i 's/CONFIG_GRUB2=y/# CONFIG_GRUB2 is not set/' .config
        
    - name: Skip GRUB2 compilation
      run: |
        cd immortalwrt
        
        echo "ðŸ›‘ è·³è¿‡ GRUB2 ç¼–è¯‘..."
        
        # æ ‡è®° GRUB2 ä¸ºå·²ç¼–è¯‘ï¼Œè·³è¿‡ç¼–è¯‘
        mkdir -p package/boot/grub2/build_dir/host
        touch package/boot/grub2/stamp-compile 2>/dev/null || true
        touch package/boot/grub2/stamp-install 2>/dev/null || true
        
        echo "âœ… GRUB2 ç¼–è¯‘å·²è·³è¿‡"
        
    - name: Fast parallel build
      run: |
        cd immortalwrt
        
        echo "âš¡ å¼€å§‹å…¨é€Ÿç¼–è¯‘..."
        echo "========================================"
        echo "ç³»ç»Ÿä¿¡æ¯:"
        echo "CPUæ ¸å¿ƒ: $(nproc)"
        echo "å†…å­˜: $(free -h | awk '/Mem:/ {print $2}')"
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "========================================"
        
        export MAKE_JOBS=$(nproc)
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo ""
        echo "ðŸ”§ ä½¿ç”¨ä¼˜åŒ–ç¼–è¯‘å‚æ•°..."
        
        echo "è·³è¿‡éƒ¨åˆ†å·¥å…·ç¼–è¯‘ä»¥åŠ é€Ÿ..."
        mkdir -p tools/erofs-utils/build_dir/host
        mkdir -p tools/padjffs2/build_dir/host
        mkdir -p tools/quilt/build_dir/host
        touch tools/erofs-utils/stamp-compile 2>/dev/null || true
        touch tools/padjffs2/stamp-compile 2>/dev/null || true
        touch tools/quilt/stamp-compile 2>/dev/null || true
        
        echo "æ‰§è¡Œå…¨é€Ÿç¼–è¯‘..."
        
        # ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
        make -j$(nproc) V=sc 2>&1 | tee fast-build.log || {
          echo "âš ï¸ å…¨é€Ÿç¼–è¯‘å¤±è´¥ï¼Œå°è¯•åˆ†æ­¥ç¼–è¯‘..."
          
          echo "æ­¥éª¤1: å·¥å…·é“¾"
          make toolchain/compile -j$(nproc) 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤2: å†…æ ¸"
          make target/linux/compile -j$(nproc) 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤3: åŸºç¡€åŒ…"
          make package/base-files/compile -j$(nproc) 2>&1 | tee -a fast-build.log
          make package/busybox/compile -j$(nproc) 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤4: ç½‘ç»œåŒ…"
          make package/dnsmasq/compile -j$(nproc) 2>&1 | tee -a fast-build.log
          make package/firewall/compile -j$(nproc) 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤5: æ— çº¿é©±åŠ¨"
          make package/kmod-ath9k/compile -j$(nproc) 2>&1 | tee -a fast-build.log
          
          echo "æ­¥éª¤6: æœ€ç»ˆç¼–è¯‘"
          make -j$(nproc) 2>&1 | tee -a fast-build.log || {
            echo "âš ï¸ æœ€ç»ˆæ­¥éª¤å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            make -j1 2>&1 | tee -a fast-build.log
          }
        }
        
        echo "========================================"
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Quick firmware check
      run: |
        cd immortalwrt
        
        echo "ðŸ” å¿«é€Ÿæ£€æŸ¥å›ºä»¶..."
        
        if ls bin/targets/ar71xx/generic/*.bin 1>/dev/null 2>&1; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼æ‰¾åˆ°å›ºä»¶:"
          ls -lh bin/targets/ar71xx/generic/*.bin | head -5
          
          SQUASHFS_FILE=$(find bin/targets/ar71xx/generic -name "*squashfs-sysupgrade*.bin" 2>/dev/null | head -1)
          if [ -n "$SQUASHFS_FILE" ]; then
            echo "ðŸŽ¯ æ‰¾åˆ° squashfs-sysupgrade å›ºä»¶"
            ls -lh "$SQUASHFS_FILE"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          find bin/targets/ar71xx/generic -type f 2>/dev/null | head -10 || echo "æ— æ–‡ä»¶"
        fi
        
    - name: Upload fast firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: tl-wr703n-fast-firmware
        path: immortalwrt/bin/targets/ar71xx/generic/*.bin
        retention-days: 7
        
    - name: Upload quick build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fast-build-logs
        path: immortalwrt/fast-build.log
        retention-days: 3
