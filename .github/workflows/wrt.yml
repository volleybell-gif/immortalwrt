name: Build ImmortalWrt for TP-WR703N (16M)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/build.yml'
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  TARGET: ath79
  SUBTARGET: tiny
  PROFILE: tp-link_tl-wr703n-v1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Cache ccache
      uses: actions/cache@v4
      id: cache-ccache
      with:
        path: |
          ~/.ccache
          openwrt/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Cache build directories
      uses: actions/cache@v4
      id: cache-build
      with:
        path: |
          openwrt/dl
          openwrt/build_dir
          openwrt/staging_dir
        key: ${{ runner.os }}-immortalwrt-${{ env.REPO_BRANCH }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-${{ env.REPO_BRANCH }}-
          ${{ runner.os }}-immortalwrt-

    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python2.7-dev python3-pip \
          python3-setuptools python3-dev rsync subversion swig time xsltproc \
          zlib1g-dev unzip wget upx-ucl

    - name: Clone ImmortalWrt source
      run: |
        if [ ! -d "openwrt" ]; then
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        else
          echo "Directory openwrt already exists, skipping clone."
        fi

    - name: Setup build environment
      run: |
        cd openwrt
        
        # 清理可能存在的配置文件
        rm -f .config .config.old
        
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 设置目标平台
        cat > .config << 'EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_tiny=y
CONFIG_TARGET_ath79_tiny_DEVICE_tp-link_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14
CONFIG_CCACHE=y
# 禁用大体积包
# CONFIG_PACKAGE_luci is not set
# CONFIG_PACKAGE_luci-ssl is not set
# CONFIG_PACKAGE_wpad-basic-wolfssl is not set
# CONFIG_PACKAGE_wpad-basic-openssl is not set
CONFIG_PACKAGE_wpad-basic=y
# CONFIG_PACKAGE_firewall4 is not set
# CONFIG_PACKAGE_nftables is not set
# 精简内核
CONFIG_KERNEL_BUILD_USER="ImmortalWrt"
CONFIG_KERNEL_BUILD_DOMAIN="immortalwrt.org"
# 移除调试信息减小体积
CONFIG_DEBUG_INFO=n
CONFIG_USE_MKLIBS=n
# 优化编译
CONFIG_CCACHE_DIR="/tmp/ccache"
CONFIG_CCACHE_BIN="/usr/bin/ccache"
CONFIG_BUILD_LOG=y
EOF
        
        # 应用配置并检查
        make defconfig
        echo "=== 配置文件内容 ==="
        head -50 .config

    - name: Download pre-compiled files
      run: |
        cd openwrt
        make download -j$(nproc)
        find dl -size +1024M -exec rm -f {} \;

    - name: Build firmware
      run: |
        cd openwrt
        
        # 设置ccache
        ccache --max-size=2G
        ccache --set-config=cache_dir=/tmp/ccache
        export CCACHE_DIR="/tmp/ccache"
        export CCACHE_BASEDIR="$(pwd)"
        
        # 获取CPU核心数
        CPU_CORES=$(($(nproc) - 2))
        if [ $CPU_CORES -lt 1 ]; then
          CPU_CORES=1
        fi
        
        echo "========================================="
        echo "开始编译，使用 ${CPU_CORES} 线程"
        echo "CCache 状态:"
        ccache -s
        echo "========================================="
        
        # 并行编译内核
        make -j${CPU_CORES} tools/install
        make -j${CPU_CORES} toolchain/install
        
        # 编译固件 - 移除了有问题的 time 命令
        make -j${CPU_CORES} V=s 2>&1 | tee build.log || {
          echo "多线程编译失败，尝试单线程编译..."
          make -j1 V=s 2>&1 | tee build-error.log
          exit 1
        }
        
        echo "========================================="
        echo "编译完成，检查固件大小..."
        find bin/targets -name "*.bin" -o -name "*.img" | xargs ls -lh
        echo "========================================="

    - name: Check firmware size
      run: |
        cd openwrt
        FIRMWARE=$(find bin/targets -name "*squashfs-sysupgrade*.bin" -o -name "*sysupgrade*.bin" | head -1)
        
        if [ -z "$FIRMWARE" ]; then
          echo "错误：未找到固件文件！"
          ls -la bin/targets/
          exit 1
        fi
        
        SIZE=$(stat -c%s "$FIRMWARE")
        MAX_SIZE=16777216
        
        echo "固件文件: $FIRMWARE"
        echo "固件大小: $SIZE 字节 ($(($SIZE/1024/1024)) MB)"
        
        if [ $SIZE -gt $MAX_SIZE ]; then
          echo "错误：固件大小超过16MB限制！"
          exit 1
        else
          echo "✓ 固件大小检查通过"
        fi

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-tp-wr703n-16m
        path: |
          openwrt/bin/targets/ath79/tiny/*.bin
          openwrt/bin/targets/ath79/tiny/*.manifest
        retention-days: 30

    - name: Cleanup large files
      if: always()
      run: |
        find . -name "*.log" -size +100M -delete 2>/dev/null || true
        du -sh ./* 2>/dev/null | sort -hr | head -10 || true
