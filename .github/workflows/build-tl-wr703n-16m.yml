name: Build ImmortalWrt for TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ImmortalWrt Version'
        required: false
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache git libncurses5-dev libssl-dev python3 python3-dev
        sudo apt-get install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip wget curl
        sudo apt-get install -y gawk file time bc quilt libtool libtool-bin automake autoconf
        
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.version }}
        cd immortalwrt
        
        # 修改为16MB分区
        if [ -f "target/linux/ar71xx/image/legacy.mk" ]; then
          sed -i 's/IMAGE_SIZE := .*/IMAGE_SIZE := 16064k/' target/linux/ar71xx/image/legacy.mk
          echo "Partition size set to 16MB"
        fi
        
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Configure for TL-WR703N
      run: |
        cd immortalwrt
        
        # 创建配置文件
        cat > .config << EOF
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_ATH_USER_REGD=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_opkg=y
EOF
        
        make defconfig
        
    - name: Build firmware
      run: |
        cd immortalwrt
        make -j$(nproc)
        
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware-tl-wr703n
        path: immortalwrt/bin/targets/ar71xx/generic/
