name: Build ImmortalWrt for TP-WR703N

on:
  workflow_dispatch:  # 手动触发
    inputs:
      version:
        description: '固件版本'
        required: false
        default: 'v1.0'
  push:
    branches: [ main, master ]
  schedule:
    # 每周日早上3点自动构建（UTC时间）
    - cron: '0 3 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  TARGET: ath79
  SUBTARGET: tiny
  PROFILE: tplink_tl-wr703n-v1
  # 调整为16MB闪存配置（使用tiny版本）
  FLASH_SIZE: 16
  # 并行编译设置
  JOBS: ${{ github.runner.hardware_concurrency || 4 }}
  CCACHE_SIZE: 2G

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: 检出工作流仓库
      uses: actions/checkout@v3
    
    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          gcc \
          g++ \
          libncurses-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          wget \
          curl \
          git \
          subversion \
          unzip \
          bc \
          ccache \
          p7zip-full \
          gettext \
          gawk \
          zlib1g-dev \
          libelf-dev
    
    - name: 配置ccache缓存
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          openwrt/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-
    
    - name: 下载源码
      run: |
        git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        echo "克隆完成"
    
    - name: 配置 feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        # 安装额外的包（如果需要）
        ./scripts/feeds install luci
        ./scripts/feeds install luci-app-firewall
        ./scripts/feeds install luci-app-upnp
    
    - name: 配置编译选项
      run: |
        cd openwrt
        # 使用预设的703n配置
        if [ -f "configs/config.tplink_tl-wr703n-v1" ]; then
          cp configs/config.tplink_tl-wr703n-v1 .config
        else
          # 手动配置
          cat > .config << EOF
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_tiny=y
CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=104
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-app-firewall=y
EOF
        fi
        
        # 调整16MB闪存设置
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=104" >> .config
        echo "CONFIG_VMLINUX_COMPRESSION_NONE=y" >> .config
        
        # 启用ccache
        echo "CONFIG_CCACHE=y" >> .config
        
        # 应用配置
        make defconfig
    
    - name: 自定义配置（可选）
      run: |
        cd openwrt
        # 如果需要自定义配置，可以在这里修改
        # 例如：启用更多功能
        sed -i 's/# CONFIG_PACKAGE_luci-app-upnp is not set/CONFIG_PACKAGE_luci-app-upnp=y/' .config
        
        # 确保16MB闪存设置
        sed -i 's/\(CONFIG_TARGET_KERNEL_PARTSIZE=\).*/\116/' .config
        sed -i 's/\(CONFIG_TARGET_ROOTFS_PARTSIZE=\).*/\1104/' .config
        
        # 更新配置
        make defconfig
    
    - name: 下载预编译工具链和软件包
      run: |
        cd openwrt
        # 预下载所有必要的文件
        make -j$JOBS download || make -j$JOBS download
        
        # 检查下载是否完整
        make -j$JOBS tools/compile
        make -j$JOBS toolchain/compile
    
    - name: 开始编译
      run: |
        cd openwrt
        # 使用多线程编译
        echo "开始编译，使用 $JOBS 个线程"
        
        # 编译内核
        make -j$JOBS target/compile || make -j1 V=s
        
        # 编译固件
        make -j$JOBS || make -j1 V=s
        
        # 检查编译结果
        ls -la bin/targets/$TARGET/$SUBTARGET/
    
    - name: 重命名固件文件
      run: |
        cd openwrt
        FIRMWARE_PATH="bin/targets/$TARGET/$SUBTARGET"
        ORIGINAL_FILE=$(ls $FIRMWARE_PATH/*squashfs*sysupgrade*.bin 2>/dev/null | head -1)
        
        if [ -f "$ORIGINAL_FILE" ]; then
          DATE=$(date +"%Y%m%d")
          NEW_NAME="immortalwrt-21.02-ath79-tiny-tplink_tl-wr703n-v1-16m-squashfs-sysupgrade-$DATE.bin"
          cp "$ORIGINAL_FILE" "$FIRMWARE_PATH/$NEW_NAME"
          echo "固件已重命名为: $NEW_NAME"
        else
          echo "错误：未找到固件文件"
          ls -la $FIRMWARE_PATH/
          exit 1
        fi
    
    - name: 上传固件到Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: immortalwrt-tp-wr703n-16m
        path: |
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*squashfs*sysupgrade*.bin
          openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*.manifest
        retention-days: 7
    
    - name: 上传固件到Release（可选）
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*squashfs*sysupgrade*.bin
    
    - name: 清理工作空间
      if: always()
      run: |
        # 清理部分文件，保留编译缓存
        cd openwrt
        make clean
