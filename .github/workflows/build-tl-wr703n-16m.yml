name: Build ImmortalWrt for TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ImmortalWrt Version'
        required: true
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.version }}
        
    - name: Configure build
      run: |
        cd immortalwrt
        
        # 创建最小配置
        cat > .config << 'EOF'
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
EOF
        
    - name: Build firmware
      run: |
        cd immortalwrt
        make defconfig
        echo "Build started at $(date)"
        make -j$(nproc)
        echo "Build completed at $(date)"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: immortalwrt/bin/targets/ar71xx/generic/
