name: Build ImmortalWrt for TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ImmortalWrt Version'
        required: true
        default: 'openwrt-21.02'
      clean_build:
        description: 'Clean Build'
        required: true
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.sha }}
        max-size: 2G
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-dev \
          subversion \
          flex \
          bison \
          libelf-dev \
          zlib1g-dev \
          rsync \
          unzip \
          wget \
          curl \
          gawk \
          file \
          time \
          bc \
          quilt \
          libtool \
          libtool-bin \
          automake \
          autoconf
          
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.version }}
        cd immortalwrt
        
        # ä¿®æ”¹è®¾å¤‡åˆ†åŒºä¸º16MB
        if [ -f "target/linux/ar71xx/image/legacy.mk" ]; then
          sed -i '/define Device\/tplink_tl-wr703n-v1/,/endef/ {
            /IMAGE_SIZE/ s/:=.*/:= 16064k/
          }' target/linux/ar71xx/image/legacy.mk
          echo "âœ… å·²ä¿®æ”¹åˆ†åŒºå¤§å°ä¸º16MB"
        fi
        
        # æ›´æ–°feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Create configuration
      run: |
        cd immortalwrt
        
        # åˆ›å»ºæœ€å°é…ç½®æ–‡ä»¶
        cat > .config << 'EOF'
# Target System
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y

# Image Configuration
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y

# Base System
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_BUSYBOX_CUSTOM=y
CONFIG_BUSYBOX_CONFIG_FEATURE_USE_INITTAB=y
CONFIG_BUSYBOX_CONFIG_FEATURE_EDITING=y

# Essential packages
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_ubox=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_logd=y
CONFIG_PACKAGE_uhttpd=y

# Network
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y

# Wireless
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_kmod-ath=y
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath9k-common=y
CONFIG_ATH_USER_REGD=y

# LuCI (å¯é€‰)
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-app-firewall=y

# 16MB Optimization
CONFIG_PACKAGE_luci-app-ddns=n
CONFIG_PACKAGE_luci-app-upnp=n
CONFIG_PACKAGE_luci-app-samba=n
CONFIG_PACKAGE_luci-app-minidlna=n

# Kernel modules
CONFIG_PACKAGE_kmod-nls-base=y
CONFIG_PACKAGE_kmod-ipv6=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-conntrack=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-ipt-offload=y

# BPF support (ä¿æŒå¯ç”¨)
CONFIG_PACKAGE_kmod-bpf=y
CONFIG_PACKAGE_kmod-sched-bpf=y

# Clean build option
EOF
        
        # ç”Ÿæˆdefconfig
        make defconfig
        
    - name: Build firmware (multi-threaded)
      run: |
        cd immortalwrt
        
        # ç¡®å®šçº¿ç¨‹æ•°ï¼Œç•™å‡º1ä¸ªæ ¸å¿ƒç»™ç³»ç»Ÿ
        CPU_COUNT=$(nproc)
        BUILD_THREADS=$(( CPU_COUNT - 1 ))
        if [ $BUILD_THREADS -lt 1 ]; then
          BUILD_THREADS=1
        fi
        if [ $BUILD_THREADS -gt 8 ]; then
          BUILD_THREADS=8  # é™åˆ¶æœ€å¤§çº¿ç¨‹æ•°
        fi
        
        echo "ðŸ”„ ä½¿ç”¨ $BUILD_THREADS ä¸ªçº¿ç¨‹è¿›è¡Œç¼–è¯‘..."
        
        # ç¼–è¯‘å‘½ä»¤
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          make clean
        fi
        
        # ä½¿ç”¨å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œè¯¦ç»†è¾“å‡º
        make -j$BUILD_THREADS V=s 2>&1 | tee build.log || {
          echo "âš ï¸  é¦–æ¬¡ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          make -j1 V=sc 2>&1 | tee build-single.log
        }
        
    - name: Check firmware files
      run: |
        cd immortalwrt
        echo "ðŸ“ æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
        
        if ls bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin 1>/dev/null 2>&1; then
          echo "âœ… æ‰¾åˆ°squashfs-sysupgradeå›ºä»¶:"
          ls -lh bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin
          
          # æ£€æŸ¥å›ºä»¶å¤§å°
          for file in bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin; do
            size=$(stat -c%s "$file")
            echo "ðŸ“Š $file å¤§å°: $((size / 1024 / 1024))MB ($((size / 1024))KB)"
          done
        else
          echo "âŒ æœªæ‰¾åˆ°squashfs-sysupgradeå›ºä»¶"
          echo "ðŸ“ å½“å‰ç›®å½•å†…å®¹:"
          find bin/targets/ar71xx/generic/ -type f -name "*.bin" 2>/dev/null || echo "æ— .binæ–‡ä»¶"
          exit 1
        fi
        
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-tl-wr703n-16m
        path: |
          immortalwrt/bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin
          immortalwrt/bin/targets/ar71xx/generic/*.manifest
        retention-days: 7
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/build-single.log
        retention-days: 7
