name: Build ImmortalWrt for TL-WR703N 16MB

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ImmortalWrtç‰ˆæœ¬'
        required: true
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache git libncurses5-dev libssl-dev python3 python3-dev
        sudo apt-get install -y subversion flex bison libelf-dev zlib1g-dev rsync unzip wget curl
        sudo apt-get install -y gawk file time bc quilt libtool libtool-bin automake autoconf
        
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b ${{ github.event.inputs.version }}
        
    - name: Apply 16MB patch
      run: |
        cd immortalwrt
        
        echo "æ­£åœ¨é…ç½®16MBé—ªå­˜æ”¯æŒ..."
        
        # ä¿®æ”¹TL-WR703Nåˆ†åŒºå¤§å°ä¸º16MB
        if [ -f "target/linux/ar71xx/image/legacy.mk" ]; then
          echo "æ‰¾åˆ°legacy.mkï¼Œä¿®æ”¹åˆ†åŒºå¤§å°..."
          
          # å¤‡ä»½åŽŸæ–‡ä»¶
          cp target/linux/ar71xx/image/legacy.mk target/linux/ar71xx/image/legacy.mk.bak
          
          # ä¿®æ”¹IMAGE_SIZEä¸º16MB
          sed -i '/define Device\/tplink_tl-wr703n-v1/,/endef/ {
            s/IMAGE_SIZE := .*/IMAGE_SIZE := 16064k/
          }' target/linux/ar71xx/image/legacy.mk
          
          echo "âœ… åˆ†åŒºå¤§å°å·²è®¾ç½®ä¸º16MB"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°legacy.mkæ–‡ä»¶"
        fi
        
        # æ›´æ–°feeds
        echo "æ›´æ–°feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Configure build
      run: |
        cd immortalwrt
        
        echo "æ­£åœ¨ç”Ÿæˆé…ç½®æ–‡ä»¶..."
        
        # åˆ›å»ºTL-WR703Né…ç½®æ–‡ä»¶
        cat > .config << 'EOF'
# Target System
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr703n-v1=y

# Image Configuration (16MB flash)
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_ROOTFS_JFFS2=n
CONFIG_TARGET_ROOTFS_EXT4FS=n

# Base System
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_BUSYBOX_CUSTOM=y
CONFIG_BUSYBOX_CONFIG_FEATURE_USE_INITTAB=y

# Essential packages
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_ubox=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_logd=y

# Network
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y

# Wireless
CONFIG_PACKAGE_kmod-ath=y
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath9k-common=y
CONFIG_ATH_USER_REGD=y

# Kernel modules
CONFIG_PACKAGE_kmod-nls-base=y
CONFIG_PACKAGE_kmod-ipv6=y
CONFIG_PACKAGE_kmod-ipt-core=y
CONFIG_PACKAGE_kmod-ipt-conntrack=y
CONFIG_PACKAGE_kmod-ipt-nat=y

# LuCI Webç•Œé¢ï¼ˆå¯é€‰ï¼‰
# CONFIG_PACKAGE_luci=y
# CONFIG_PACKAGE_luci-base=y
# CONFIG_PACKAGE_uhttpd=y

# 16MBä¼˜åŒ– - ç¦ç”¨ä¸éœ€è¦çš„åŒ…
CONFIG_PACKAGE_luci=n
CONFIG_PACKAGE_uhttpd=n
CONFIG_PACKAGE_emortal_default-settings=n
CONFIG_PACKAGE_luci-app-ddns=n
CONFIG_PACKAGE_luci-app-upnp=n
CONFIG_PACKAGE_luci-app-samba=n
CONFIG_PACKAGE_luci-app-minidlna=n

# BPFæ”¯æŒï¼ˆä¿æŒå¯ç”¨ï¼‰
CONFIG_PACKAGE_kmod-bpf=y
EOF
        
        echo "ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
    - name: Build firmware with multiple threads
      run: |
        cd immortalwrt
        
        echo "ðŸ”„ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        
        # è®¡ç®—çº¿ç¨‹æ•°ï¼ˆç•™å‡º1ä¸ªæ ¸å¿ƒç»™ç³»ç»Ÿï¼‰
        CPU_COUNT=$(nproc)
        BUILD_THREADS=$(( CPU_COUNT - 1 ))
        if [ $BUILD_THREADS -lt 1 ]; then
          BUILD_THREADS=1
        fi
        
        echo "ä½¿ç”¨ $BUILD_THREADS ä¸ªçº¿ç¨‹è¿›è¡Œç¼–è¯‘..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # å¼€å§‹ç¼–è¯‘
        make -j$BUILD_THREADS V=s 2>&1 | tee build.log || {
          echo "âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          make -j1 V=sc 2>&1 | tee build-single.log
        }
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    - name: Check firmware files
      run: |
        cd immortalwrt
        
        echo "ðŸ“ æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶..."
        
        # åˆ—å‡ºæ‰€æœ‰å›ºä»¶æ–‡ä»¶
        if ls bin/targets/ar71xx/generic/*.bin 1>/dev/null 2>&1; then
          echo "âœ… æ‰¾åˆ°ä»¥ä¸‹å›ºä»¶æ–‡ä»¶:"
          ls -lh bin/targets/ar71xx/generic/*.bin
          
          # ç‰¹åˆ«æ£€æŸ¥squashfs-sysupgrade
          if ls bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin 1>/dev/null 2>&1; then
            echo "âœ… æ‰¾åˆ°squashfs-sysupgradeå›ºä»¶"
            for file in bin/targets/ar71xx/generic/*squashfs-sysupgrade*.bin; do
              size=$(stat -c%s "$file")
              echo "ðŸ“Š $file å¤§å°: $((size / 1024 / 1024))MB ($((size / 1024))KB)"
            done
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "ðŸ“ ç›®å½•å†…å®¹:"
          find bin/targets/ar71xx/generic/ -type f 2>/dev/null || echo "æ— æ–‡ä»¶"
        fi
        
    - name: Upload firmware artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-tl-wr703n-16m-firmware
        path: |
          immortalwrt/bin/targets/ar71xx/generic/*.bin
          immortalwrt/bin/targets/ar71xx/generic/*.manifest
        retention-days: 7
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
          immortalwrt/build-single.log
        retention-days: 7