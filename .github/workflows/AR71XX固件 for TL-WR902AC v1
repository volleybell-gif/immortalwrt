
name: Build AR71XX固件 for TL-WR902AC v1

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt版本'
        required: true
        default: '18.06'

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout源码
      uses: actions/checkout@v3
      
    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache curl git libncurses5-dev \
        libssl-dev python2.7 python-dev meson gperf help2man
        
    - name: 配置AR71XX目标
      run: |
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_generic=y" >> .config
        echo "CONFIG_TARGET_ar71xx_generic_DEVICE_tl-wr902ac-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=256" >> .config
        
    - name: 编译固件
      run: |
        make defconfig
        make -j$(nproc) V=s
        
    - name: 上传固件产物
      uses: actions/upload-artifact@v3
      with:
        name: ar71xx-tl-wr902ac-v1-firmware
        path: bin/targets/ar71xx/generic/
        retention-days: 30
