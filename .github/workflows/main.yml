name: Build ImmortalWrt for TL-WR702N v1 (16MB)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ImmortalWrt分支版本'
        required: true
        default: 'openwrt-21.02'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache git libncurses5-dev libssl-dev python3
        sudo apt-get clean
        
    - name: Download ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b openwrt-21.02
        
    - name: Basic configuration
      run: |
        cd immortalwrt
        # 创建一个最小配置
        cat > .config << EOF
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr702n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_ATH_USER_REGD=y
EOF
        
    - name: Build firmware
      run: |
        cd immortalwrt
        # 先只构建内核和基础包
        make kernel_compile -j2 V=s
        make package/base-files/compile -j2 V=s
        make package/busybox/compile -j2 V=s
        
        # 然后尝试完整构建
        make -j2 V=s || make -j1 V=s
