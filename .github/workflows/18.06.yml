
name: Build ImmortalWrt 18.06 for TL-WR902AC v1

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      clean_build:
        description: '执行完整清理编译'
        required: false
        default: false

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
        g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
        libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
        libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
        ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
        python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
        upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        sudo apt-get clean
        
    - name: Clone ImmortalWrt 18.06 source
      run: |
        git clone -b openwrt-18.06 --single-branch --depth=1 --filter=blob:none https://github.com/immortalwrt/immortalwrt.git openwrt
        
    - name: Update feeds
      working-directory: ./openwrt
      run: |
        timeout 300 ./scripts/feeds update -a || (echo "Feeds update timeout, retrying..." && ./scripts/feeds update -a)
        ./scripts/feeds install -a
        
    - name: Configure for TL-WR902AC v1 (16MB)
      working-directory: ./openwrt
      run: |
        # 设置目标平台为ar71xx（18.06版本使用）
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_tiny=y" >> .config
        echo "CONFIG_TARGET_ar71xx_tiny_DEVICE_tplink_tl-wr902ac-v1=y" >> .config
        
        # 文件系统配置 - 确保生成squashfs-sysupgrade
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_EXT4FS=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_JFFS2=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
        
        # 基础软件包
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        
        # 16MB专用优化
        echo "CONFIG_PACKAGE_luci-ssl=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=n" >> .config
        echo "CONFIG_PACKAGE_ppp=n" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-extra=n" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-nathelper-extra=n" >> .config
        
        # 编译优化
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
        
        # 禁用调试信息
        echo "CONFIG_KERNEL_KALLSYMS=n" >> .config
        echo "CONFIG_KERNEL_DEBUG_INFO=n" >> .config
        
    - name: Build firmware
      working-directory: ./openwrt
      run: |
        make defconfig
        make kernel_oldconfig
        timeout 120m make -j$(nproc) V=s || (echo "Build timeout, checking logs..." && tail -100 logs/build.log)
        
    - name: Verify firmware
      working-directory: ./openwrt
      run: |
        if [ -f "bin/targets/ar71xx/tiny/immortalwrt-ar71xx-tiny-tl-wr902ac-v1-squashfs-sysupgrade.bin" ]; then
          FIRMWARE_SIZE=$(stat -c%s "bin/targets/ar71xx/tiny/immortalwrt-ar71xx-tiny-tl-wr902ac-v1-squashfs-sysupgrade.bin")
          echo "Firmware generated successfully!"
          echo "File size: $FIRMWARE_SIZE bytes"
          if [ $FIRMWARE_SIZE -gt 15000000 ]; then
            echo "WARNING: Firmware size exceeds 15MB, may be too large for 16MB flash"
          fi
        else
          echo "ERROR: Firmware file not found"
          ls -la bin/targets/ar71xx/tiny/
          exit 1
        fi

