name: Build ImmortalWrt for TP-WR703N

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  DEVICE: tplink_tl-wr703n

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        thread_count: [4]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ github.sha }}
        restore-keys: ccache-
    
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 --branch=${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          python3-venv \
          python3-dev \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev
    
    - name: Configure build
      run: |
        cd openwrt
        
        # 清理工作区
        rm -f .config .config.old
        if [ -d "tmp" ]; then rm -rf tmp; fi
        
        # 更新和安装 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 创建最小配置 - 16M闪存，squashfs文件系统
        cat > .config << 'CONFIG_EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_tiny=y
CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr703n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_IMAGES_PAD=y
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
CONFIG_DEBUG_INFO=n
CONFIG_USE_MKLIBS=n
CONFIG_TARGET_MULTI_PROFILE=n
CONFIG_IMAGEOPT=y
CONFIG_TARGET_IMAGES_INCLUDE_KERNEL=y
CONFIG_TARGET_IMAGES_INCLUDE_DTB=y
CONFIG_TARGET_IMAGES_INCLUDE_ROOTFS=y

# 基础系统
CONFIG_PACKAGE_busybox=y
CONFIG_BUSYBOX_CUSTOM=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_fstools=y
CONFIG_PACKAGE_jsonfilter=y
CONFIG_PACKAGE_libc=y
CONFIG_PACKAGE_libgcc=y
CONFIG_PACKAGE_libpthread=y
CONFIG_PACKAGE_librt=y
CONFIG_PACKAGE_libubox=y
CONFIG_PACKAGE_libuci=y
CONFIG_PACKAGE_logd=y
CONFIG_PACKAGE_mtd=y
CONFIG_PACKAGE_netifd=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_procd=y
CONFIG_PACKAGE_swconfig=y
CONFIG_PACKAGE_uboot-envtools=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_urandom-seed=y
CONFIG_PACKAGE_urngd=y
CONFIG_PACKAGE_usign=y

# 网络配置
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
CONFIG_PACKAGE_iptables-mod-ipopt=y
CONFIG_PACKAGE_iptables-mod-nat-extra=y
CONFIG_PACKAGE_wpad-basic=y
CONFIG_PACKAGE_hostapd-common=y
CONFIG_PACKAGE_iw=y
CONFIG_PACKAGE_iwinfo=y

# 无线支持
CONFIG_PACKAGE_kmod-ath=y
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath9k-common=y
CONFIG_PACKAGE_kmod-cfg80211=y
CONFIG_PACKAGE_kmod-mac80211=y

# 内核模块
CONFIG_PACKAGE_kmod-gpio-button-hotplug=y
CONFIG_PACKAGE_kmod-ipt-conntrack=y
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-nat=y
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y

# 文件系统
CONFIG_PACKAGE_kmod-fs-squashfs=y
CONFIG_PACKAGE_kmod-nls-base=y
CONFIG_EOF
        
        # 应用配置
        make defconfig
        
        # 创建自定义配置文件
        mkdir -p files/etc/config
        
        # network配置 - 唯一网口作为LAN口，IP: 192.168.1.1
        cat > files/etc/config/network << 'NETWORK_EOF'
config interface 'loopback'
    option ifname 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config interface 'lan'
    option ifname 'eth0'
    option proto 'static'
    option ipaddr '192.168.1.1'
    option netmask '255.255.255.0'
    option ip6assign '60'
NETWORK_EOF
        
        # wireless配置 - 开启无线
        cat > files/etc/config/wireless << 'WIRELESS_EOF'
config wifi-device 'radio0'
    option type 'mac80211'
    option channel '11'
    option hwmode '11g'
    option path 'platform/ar933x_wmac'
    option htmode 'HT20'
    option disabled '0'
    option txpower '20'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid 'TP-WR703N-ImmortalWrt'
    option encryption 'psk2'
    option key '12345678'
WIRELESS_EOF
        
        # firewall配置
        cat > files/etc/config/firewall << 'FIREWALL_EOF'
config defaults
    option syn_flood '1'
    option input 'ACCEPT'
    option output 'ACCEPT'
    option forward 'REJECT'

config zone
    option name 'lan'
    list network 'lan'
    option input 'ACCEPT'
    option output 'ACCEPT'
    option forward 'ACCEPT'
FIREWALL_EOF
        
        # system配置
        cat > files/etc/config/system << 'SYSTEM_EOF'
config system
    option hostname 'TP-WR703N'
    option timezone 'CST-8'

config timeserver 'ntp'
    option enabled '1'
    list server 'time1.cloud.tencent.com'
    list server 'time2.cloud.tencent.com'
    list server 'time3.cloud.tencent.com'
SYSTEM_EOF
        
        echo "✅ 配置完成"
        echo "设备: TP-WR703N"
        echo "固件类型: 16M squashfs-sysupgrade"
        echo "网络: eth0作为LAN口，IP: 192.168.1.1"
        echo "无线: 已开启，SSID: TP-WR703N-ImmortalWrt"
    
    - name: Build with ccache and multi-threading
      run: |
        cd openwrt
        
        # 设置编译线程数
        MAKE_JOBS=${{ matrix.thread_count }}
        
        # 启用ccache加速
        export CCACHE_DIR=~/.ccache
        export CCACHE_MAXSIZE=2G
        export CCACHE_COMPRESS=1
        export CCACHE_COMPRESSLEVEL=6
        
        # 显示ccache状态
        ccache -s
        
        echo "开始编译，使用 $MAKE_JOBS 个线程..."
        echo "编译时间预估: 15-60分钟"
        
        # 下载所有源码包
        echo "=== 下载源码包 ==="
        time make download -j$MAKE_JOBS || echo "下载完成，继续编译..."
        
        # 开始编译，使用ccache加速
        echo "=== 开始编译固件 ==="
        time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ $? -eq 0 ]; then
          echo "✅ 编译成功"
        else
          echo "❌ 编译失败，查看错误日志..."
          tail -100 build.log
          exit 1
        fi
        
        # 编译完成后再次显示ccache状态
        ccache -s
    
    - name: Check and prepare artifacts
      run: |
        cd openwrt
        
        echo "=== 查找生成的固件 ==="
        
        # 首先列出所有可能的固件
        echo "所有文件:"
        find bin/targets -type f -name "*.bin" -o -name "*.trx" -o -name "*.img" 2>/dev/null || true
        
        # 查找sysupgrade.bin固件
        SYSUPGRADE_FILE=$(find bin/targets -name "*sysupgrade*.bin" -type f 2>/dev/null | head -1)
        
        if [ -n "$SYSUPGRADE_FILE" ]; then
          echo "✅ 找到sysupgrade固件: $SYSUPGRADE_FILE"
          ls -lh "$SYSUPGRADE_FILE"
          
          # 检查固件大小（16M闪存，固件应小于16MB）
          FILE_SIZE=$(stat -c%s "$SYSUPGRADE_FILE")
          MAX_SIZE=$((16 * 1024 * 1024))  # 16MB
          
          if [ $FILE_SIZE -lt $MAX_SIZE ]; then
            echo "✅ 固件大小: $(($FILE_SIZE/1024/1024))MB，符合16M闪存要求"
          else
            echo "⚠️ 固件大小: $(($FILE_SIZE/1024/1024))MB，可能超出16M闪存"
          fi
        else
          # 如果没有找到sysupgrade.bin，尝试找其他固件
          echo "未找到sysupgrade.bin，搜索其他固件..."
          
          # 查找包含wr703n的固件
          ANY_FIRMWARE=$(find bin/targets -name "*wr703n*.bin" -type f 2>/dev/null | head -1)
          
          if [ -n "$ANY_FIRMWARE" ]; then
            echo "✅ 找到固件: $ANY_FIRMWARE"
            ls -lh "$ANY_FIRMWARE"
            
            # 重命名为sysupgrade.bin
            NEW_NAME="$(dirname "$ANY_FIRMWARE")/sysupgrade.bin"
            cp "$ANY_FIRMWARE" "$NEW_NAME"
            echo "已复制为: $NEW_NAME"
          else
            echo "❌ 未找到任何固件文件"
            echo "当前目录结构:"
            find bin/targets -type f 2>/dev/null | head -20
            exit 1
          fi
        fi
        
        # 创建固件信息文件
        echo "=== 创建固件信息 ==="
        cat > firmware-info.txt << 'INFO_EOF'
设备: TP-WR703N
固件: ImmortalWrt $(date +%Y%m%d)
分支: openwrt-21.02
文件系统: squashfs
类型: sysupgrade
IP地址: 192.168.1.1
无线SSID: TP-WR703N-ImmortalWrt
无线密码: 12345678
编译时间: $(date)
INFO_EOF
        
        echo "固件信息已保存到 firmware-info.txt"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-tp-wr703n-16m
        path: |
          openwrt/bin/targets/**/*sysupgrade*.bin
          openwrt/bin/targets/**/*wr703n*.bin
          openwrt/firmware-info.txt
          openwrt/build.log
        retention-days: 7
    
    - name: Upload on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-logs
        path: |
          openwrt/build.log
        retention-days: 3
