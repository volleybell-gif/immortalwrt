name: Build ImmortalWrt for TP-WR703N

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  TARGET: ath79/tiny
  DEVICE: tplink_tl-wr703n

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        thread_count: [4]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ env.DEVICE }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ env.DEVICE }}-
          ${{ runner.os }}-ccache-
    
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 --branch=${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev
    
    - name: Configure build
      run: |
        cd openwrt
        
        # 清理工作区
        rm -f .config .config.old
        if [ -d "tmp" ]; then rm -rf tmp; fi
        
        # 更新和安装 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 创建最小配置 - 简化写法
        echo "CONFIG_TARGET_ath79=y" > .config
        echo "CONFIG_TARGET_ath79_tiny=y" >> .config
        echo "CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr703n=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        echo "# CONFIG_TARGET_ROOTFS_INITRAMFS is not set" >> .config
        
        # 编译配置
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_BUILD_LOG=y" >> .config
        echo "CONFIG_KERNEL_BUILD_USER=\"ImmortalWrt\"" >> .config
        echo "CONFIG_KERNEL_BUILD_DOMAIN=\"immortalwrt.org\"" >> .config
        echo "CONFIG_DEBUG_INFO=n" >> .config
        echo "CONFIG_USE_MKLIBS=n" >> .config
        echo "CONFIG_TARGET_MULTI_PROFILE=n" >> .config
        
        # 无线驱动
        echo "CONFIG_PACKAGE_kmod-ath=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k-common=y" >> .config
        
        # 无线工具
        echo "CONFIG_PACKAGE_wpad-basic=y" >> .config
        echo "CONFIG_PACKAGE_hostapd-common=y" >> .config
        echo "CONFIG_PACKAGE_iw=y" >> .config
        echo "CONFIG_PACKAGE_iwinfo=y" >> .config
        
        # 基础网络包
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-nat-extra=y" >> .config
        
        # 禁用冲突包
        echo "# CONFIG_PACKAGE_dnsmasq-full is not set" >> .config
        echo "# CONFIG_PACKAGE_firewall4 is not set" >> .config
        echo "# CONFIG_PACKAGE_nftables is not set" >> .config
        echo "# CONFIG_PACKAGE_ppp-mod-pppoe is not set" >> .config
        
        # 禁用Luci和Web界面
        echo "# CONFIG_PACKAGE_luci is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-base is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-compat is not set" >> .config
        echo "# CONFIG_PACKAGE_uhttpd is not set" >> .config
        
        # 应用配置
        make defconfig
        
        # 创建自定义配置文件
        mkdir -p files/etc/config
        
        # network配置
        cat > files/etc/config/network << "EOF"
config interface 'loopback'
    option ifname 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config interface 'lan'
    option ifname 'eth0'
    option proto 'static'
    option ipaddr '192.168.1.1'
    option netmask '255.255.255.0'
EOF
        
        # wireless配置
        cat > files/etc/config/wireless << "EOF"
config wifi-device 'radio0'
    option type 'mac80211'
    option channel '11'
    option hwmode '11g'
    option path 'platform/ar933x_wmac'
    option htmode 'HT20'
    option disabled '0'
    option txpower '20'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid 'TP-WR703N-ImmortalWrt'
    option encryption 'psk2'
    option key '12345678'
EOF
        
        # 配置验证
        echo "=== 配置验证 ==="
        echo "设备选择:"
        grep "CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr703n" .config && echo "✅ TP-WR703N 已选中"
        echo "固件类型:"
        grep "CONFIG_TARGET_ROOTFS_SQUASHFS" .config && echo "✅ 将生成 squashfs 固件"
        echo "网络配置:"
        echo "✅ 网口: eth0 (LAN), IP: 192.168.1.1"
        echo "无线配置:"
        echo "✅ 无线已启用, SSID: TP-WR703N-ImmortalWrt"
    
    - name: Build with multi-threading
      run: |
        cd openwrt
        
        # 设置编译线程数
        MAKE_JOBS=${{ matrix.thread_count }}
        
        # 启用ccache
        export CCACHE_DIR=~/.ccache
        export CCACHE_MAXSIZE=2G
        export CCACHE_COMPRESS=1
        
        echo "使用 $MAKE_JOBS 个线程进行编译"
        
        # 开始编译 - 使用多线程
        time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ $? -eq 0 ]; then
          echo "✅ 编译成功"
        else
          echo "❌ 编译失败"
          exit 1
        fi
    
    - name: Check artifacts
      run: |
        cd openwrt
        
        echo "=== 查找固件文件 ==="
        find bin/targets -name "*wr703n*" -type f | while read file; do
          echo "找到: $file"
          ls -lh "$file"
        done
        
        # 检查 sysupgrade.bin
        if find bin/targets -name "*sysupgrade*.bin" -type f | grep -q .; then
          echo "✅ 找到 sysupgrade.bin 固件"
        else
          echo "❌ 未找到 sysupgrade.bin 固件"
          exit 1
        fi
        
        # 检查固件大小
        find bin/targets -name "*sysupgrade*.bin" -exec sh -c '
          size=$(stat -c%s "$1")
          max_size=$((16 * 1024 * 1024))
          if [ $size -gt $max_size ]; then
            echo "⚠️  警告: 固件大小 ($((size/1024/1024))MB) 接近16M限制"
          else
            echo "✅ 固件大小 ($((size/1024/1024))MB) 在安全范围内"
          fi
        ' _ {} \;
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-wr703n-${{ github.sha }}
        path: |
          openwrt/bin/targets/**/*.bin
          openwrt/build.log
        retention-days: 7
