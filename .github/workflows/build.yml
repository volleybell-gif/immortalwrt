name: Build ImmortalWrt for TP-WR703N

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  TARGET: ath79/tiny
  DEVICE: tplink_tl-wr703n

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        thread_count: [4]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ github.sha }}
        restore-keys: ccache-
    
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 --branch=${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          python3-venv \
          python3-dev \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev
    
    - name: Configure build
      run: |
        cd openwrt
        
        # 清理工作区
        rm -f .config .config.old
        if [ -d "tmp" ]; then rm -rf tmp; fi
        
        # 更新和安装 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 创建最小配置
        cat > .config << 'CONFIG_EOF'
        CONFIG_TARGET_ath79=y
        CONFIG_TARGET_ath79_tiny=y
        CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr703n=y
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=14
        CONFIG_TARGET_IMAGES_GZIP=y
        CONFIG_TARGET_IMAGES_PAD=y
        # CONFIG_TARGET_ROOTFS_INITRAMFS is not set
        CONFIG_CCACHE=y
        CONFIG_BUILD_LOG=y
        CONFIG_KERNEL_BUILD_USER="ImmortalWrt"
        CONFIG_KERNEL_BUILD_DOMAIN="immortalwrt.org"
        CONFIG_DEBUG_INFO=n
        CONFIG_USE_MKLIBS=n
        CONFIG_TARGET_MULTI_PROFILE=n
        
        # 内核配置
        CONFIG_LINUX_4_14=y
        
        # 确保生成 sysupgrade 固件
        CONFIG_IMAGEOPT=y
        CONFIG_KERNEL_KALLSYMS=y
        CONFIG_KERNEL_DEBUG_INFO=n
        
        # 基础包
        CONFIG_PACKAGE_kmod-ath=y
        CONFIG_PACKAGE_kmod-ath9k=y
        CONFIG_PACKAGE_kmod-ath9k-common=y
        CONFIG_PACKAGE_kmod-ath9k-htc=y
        CONFIG_PACKAGE_kmod-cfg80211=y
        CONFIG_PACKAGE_kmod-mac80211=y
        CONFIG_PACKAGE_wpad-basic=y
        CONFIG_PACKAGE_hostapd-common=y
        CONFIG_PACKAGE_iw=y
        CONFIG_PACKAGE_iwinfo=y
        
        # 网络基础
        CONFIG_PACKAGE_dnsmasq=y
        CONFIG_PACKAGE_firewall=y
        CONFIG_PACKAGE_iptables=y
        CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
        CONFIG_PACKAGE_iptables-mod-ipopt=y
        CONFIG_PACKAGE_iptables-mod-nat-extra=y
        
        # 系统工具
        CONFIG_PACKAGE_busybox=y
        CONFIG_BUSYBOX_CUSTOM=y
        CONFIG_PACKAGE_base-files=y
        CONFIG_PACKAGE_block-mount=y
        CONFIG_PACKAGE_dropbear=y
        CONFIG_PACKAGE_fstools=y
        CONFIG_PACKAGE_jsonfilter=y
        CONFIG_PACKAGE_libc=y
        CONFIG_PACKAGE_libgcc=y
        CONFIG_PACKAGE_libpthread=y
        CONFIG_PACKAGE_librt=y
        CONFIG_PACKAGE_libubox=y
        CONFIG_PACKAGE_libuci=y
        CONFIG_PACKAGE_logd=y
        CONFIG_PACKAGE_mtd=y
        CONFIG_PACKAGE_netifd=y
        CONFIG_PACKAGE_opkg=y
        CONFIG_PACKAGE_procd=y
        CONFIG_PACKAGE_swconfig=y
        CONFIG_PACKAGE_uboot-envtools=y
        CONFIG_PACKAGE_ubus=y
        CONFIG_PACKAGE_ubusd=y
        CONFIG_PACKAGE_uci=y
        CONFIG_PACKAGE_urandom-seed=y
        CONFIG_PACKAGE_urngd=y
        CONFIG_PACKAGE_usign=y
        
        # 文件系统
        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-squashfs=y
        CONFIG_PACKAGE_kmod-nls-base=y
        CONFIG_PACKAGE_kmod-nls-utf8=y
        
        # 排除的包（减小体积）
        # CONFIG_PACKAGE_dnsmasq-full is not set
        # CONFIG_PACKAGE_firewall4 is not set
        # CONFIG_PACKAGE_nftables is not set
        # CONFIG_PACKAGE_ppp-mod-pppoe is not set
        # CONFIG_PACKAGE_luci is not set
        # CONFIG_PACKAGE_luci-base is not set
        # CONFIG_PACKAGE_luci-compat is not set
        # CONFIG_PACKAGE_uhttpd is not set
        CONFIG_EOF
        
        # 应用配置
        make defconfig
        
        # 创建自定义配置文件
        mkdir -p files/etc/config
        
        # network配置 - 唯一网口作为LAN口
        cat > files/etc/config/network << 'EOF'
        config interface 'loopback'
            option ifname 'lo'
            option proto 'static'
            option ipaddr '127.0.0.1'
            option netmask '255.0.0.0'

        config interface 'lan'
            option ifname 'eth0'
            option proto 'static'
            option ipaddr '192.168.1.1'
            option netmask '255.255.255.0'
        EOF
        
        # wireless配置 - 开启无线
        cat > files/etc/config/wireless << 'EOF'
        config wifi-device 'radio0'
            option type 'mac80211'
            option channel '11'
            option hwmode '11g'
            option path 'platform/ar933x_wmac'
            option htmode 'HT20'
            option disabled '0'
            option txpower '20'

        config wifi-iface 'default_radio0'
            option device 'radio0'
            option network 'lan'
            option mode 'ap'
            option ssid 'TP-WR703N-ImmortalWrt'
            option encryption 'psk2'
            option key '12345678'
        EOF
        
        # firewall配置
        cat > files/etc/config/firewall << 'EOF'
        config defaults
            option syn_flood '1'
            option input 'ACCEPT'
            option output 'ACCEPT'
            option forward 'REJECT'

        config zone
            option name 'lan'
            list network 'lan'
            option input 'ACCEPT'
            option output 'ACCEPT'
            option forward 'ACCEPT'
        EOF
        
        # 配置验证
        echo "=== 配置验证 ==="
        echo "设备选择:"
        grep "CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr703n" .config && echo "✅ TP-WR703N 已选中"
        echo "固件类型:"
        grep "CONFIG_TARGET_ROOTFS_SQUASHFS" .config && echo "✅ 将生成 squashfs 固件"
        echo "网络配置:"
        if [ -f "files/etc/config/network" ]; then
          echo "✅ 自定义 network 配置已创建"
          echo "   网口: eth0 (LAN)"
          echo "   IP地址: 192.168.1.1"
        fi
        echo "无线配置:"
        if [ -f "files/etc/config/wireless" ]; then
          echo "✅ 无线已启用"
          echo "   SSID: TP-WR703N-ImmortalWrt"
        fi
        
        # 显示关键配置
        echo "=== 关键配置检查 ==="
        grep "CONFIG_IMAGEOPT\|CONFIG_TARGET_IMAGES\|CONFIG_TARGET_ROOTFS" .config
        echo "✅ 配置完成"
    
    - name: Build with multi-threading
      run: |
        cd openwrt
        
        # 设置编译线程数
        MAKE_JOBS=${{ matrix.thread_count }}
        
        # 启用ccache
        export CCACHE_DIR=~/.ccache
        export CCACHE_MAXSIZE=2G
        export CCACHE_COMPRESS=1
        
        echo "使用 $MAKE_JOBS 个线程进行编译"
        
        # 先下载源码包
        echo "=== 下载源码包 ==="
        make download -j$MAKE_JOBS
        
        # 开始编译 - 使用多线程
        echo "=== 开始编译 ==="
        time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ $? -eq 0 ]; then
          echo "✅ 编译成功"
          
          # 检查生成的固件
          echo "=== 检查生成的固件 ==="
          find bin/targets -name "*.bin" -type f | while read file; do
            echo "找到固件: $file"
            ls -lh "$file"
          done
        else
          echo "❌ 编译失败"
          exit 1
        fi
    
    - name: Check artifacts
      run: |
        cd openwrt
        
        echo "=== 查找固件文件 ==="
        echo "列出 bin/targets 目录结构:"
        find bin/targets -type f | sort
        
        echo "=== 搜索所有固件文件 ==="
        find bin/targets -name "*.bin" -type f | while read file; do
          echo "找到: $file"
          ls -lh "$file"
        done
        
        # 检查 sysupgrade.bin
        if find bin/targets -name "*sysupgrade*.bin" -type f | grep -q .; then
          echo "✅ 找到 sysupgrade.bin 固件"
        elif find bin/targets -name "*.bin" -type f | grep -q .; then
          echo "✅ 找到其他固件文件"
          echo "固件列表:"
          find bin/targets -name "*.bin" -type f
        else
          echo "❌ 未找到任何固件文件"
          echo "列出目录内容:"
          ls -la bin/targets/ath79/tiny/ || true
          exit 1
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-wr703n
        path: |
          openwrt/bin/targets/**/*.bin
          openwrt/build.log
        retention-days: 7
