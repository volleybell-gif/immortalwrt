name: Build ImmortalWrt 21.02 for AR9331 16M

on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'  # 每周日 2:00 UTC 自动编译

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout ImmortalWrt source
      uses: actions/checkout@v3
      with:
        repository: immortalwrt/immortalwrt
        ref: openwrt-21.02
        submodules: true

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load AR9331 config
      run: |
        # 设置目标为 AR9331 (ath79/tiny)
        cat > $CONFIG_FILE << EOF
        CONFIG_TARGET_ath79=y
        CONFIG_TARGET_ath79_tiny=y
        CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr741nd-v4=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=128
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        CONFIG_TARGET_ROOTFS_JFFS2=n
        CONFIG_VMLINUX_COMPRESSION_NONE=y
        CONFIG_PACKAGE_kmod-ath9k=y
        CONFIG_PACKAGE_kmod-ath9k-common=y
        CONFIG_PACKAGE_hostapd-common=y
        CONFIG_PACKAGE_wpad-basic=y
        CONFIG_PACKAGE_iw=y
        CONFIG_PACKAGE_wireless-tools=y
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-base=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIG_PACKAGE_luci-mod-admin-full=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-proto-ipv6=y
        CONFIG_PACKAGE_luci-proto-ppp=y
        CONFIG_PACKAGE_dnsmasq=y
        CONFIG_PACKAGE_dropbear=y
        CONFIG_PACKAGE_firewall=y
        CONFIG_PACKAGE_iptables=y
        CONFIG_PACKAGE_ip6tables=y
        CONFIG_PACKAGE_ppp=y
        CONFIG_PACKAGE_ppp-mod-pppoe=y
        CONFIG_PACKAGE_odhcpd-ipv6only=y
        CONFIG_PACKAGE_odhcp6c=y
        CONFIG_PACKAGE_kmod-ipt-offload=y
        # 启用无线
        CONFIG_PACKAGE_kmod-ath9k=y
        CONFIG_ATH_USER_REGD=y
        CONFIG_PACKAGE_ATH_DEBUG=y
        # 网络配置
        CONFIG_PACKAGE_dnsmasq-full=y
        CONFIG_PACKAGE_dnsmasq_full_dhcp=y
        CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y
        # LAN口配置
        CONFIG_DEVEL=y
        CONFIG_CCACHE=y
        CONFIG_BUILD_LOG=y
        EOF

    - name: Customize config
      run: |
        # 启用 ccache
        echo 'CONFIG_CCACHE=y' >> $CONFIG_FILE
        echo 'CONFIG_CCACHE_DIR="/tmp/ccache"' >> $CONFIG_FILE
        echo 'CONFIG_CCACHE_BIN="/usr/bin/ccache"' >> $CONFIG_FILE
        
        # 设置 IP 地址和 LAN 口配置
        echo 'CONFIG_TARGET_IPV6=y' >> $CONFIG_FILE
        echo 'CONFIG_TARGET_PREINIT_IP="192.168.1.1"' >> $CONFIG_FILE
        echo 'CONFIG_TARGET_PREINIT_NETMASK="255.255.255.0"' >> $CONFIG_FILE
        echo 'CONFIG_TARGET_PREINIT_BROADCAST="192.168.1.255"' >> $CONFIG_FILE
        
        # 设置闪存为 16M
        echo 'CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr741nd-v4_16M=y' >> $CONFIG_FILE
        
        # 启用多线程编译
        echo 'CONFIG_MAKE_J="$(nproc)"' >> $CONFIG_FILE

    - name: Set up ccache
      uses: actions/cache@v3
      with:
        path: /tmp/ccache
        key: ${{ runner.os }}-ccache-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Setup environment
      run: |
        # 安装编译依赖
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          xsltproc \
          zlib1g-dev \
          unzip \
          wget
        
        # 设置 ccache
        ccache -o compression=true
        ccache -M 2G
        ccache -s

    - name: Final config
      run: |
        # 应用配置
        cat $CONFIG_FILE
        make defconfig
        # 确保选择正确的设备
        echo "CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr741nd-v4=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128" >> .config
        # 启用无线驱动
        echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k-common=y" >> .config

    - name: Build image
      run: |
        # 开始编译，使用多线程
        make -j$(nproc) V=s
        # 也可以使用以下命令（不显示详细输出）
        # make -j$(nproc) V=99

    - name: Check build artifacts
      run: |
        # 检查生成的文件
        ls -la bin/targets/ath79/tiny/
        find bin/targets/ath79/tiny/ -name "*sysupgrade*.bin" -type f | head -5

    - name: Upload firmware
      uses: actions/upload-artifact@v3
      with:
        name: immortalwrt-ar9331-16m
        path: |
          bin/targets/ath79/tiny/
        if-no-files-found: error

    - name: Show ccache stats
      run: ccache -s
