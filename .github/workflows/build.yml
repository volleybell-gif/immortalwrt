name: Build ImmortalWrt for TP-WR703N

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: ${{ runner.os }}-ccache-
    
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 --branch=${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev
    
    - name: Configure build
      run: |
        cd openwrt
        
        # 清理工作区
        rm -f .config .config.old
        rm -rf tmp
        
        # 更新和安装 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 创建.config文件 - 使用简单的echo方法
        echo "CONFIG_TARGET_ath79=y" > .config
        echo "CONFIG_TARGET_ath79_tiny=y" >> .config
        echo "CONFIG_TARGET_ath79_tiny_DEVICE_tplink_tl-wr703n=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=14" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_TARGET_IMAGES_PAD=y" >> .config
        echo "# CONFIG_TARGET_ROOTFS_INITRAMFS is not set" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_BUILD_LOG=y" >> .config
        echo "CONFIG_KERNEL_BUILD_USER=\"ImmortalWrt\"" >> .config
        echo "CONFIG_KERNEL_BUILD_DOMAIN=\"immortalwrt.org\"" >> .config
        echo "CONFIG_DEBUG_INFO=n" >> .config
        echo "CONFIG_USE_MKLIBS=n" >> .config
        echo "CONFIG_TARGET_MULTI_PROFILE=n" >> .config
        echo "CONFIG_PACKAGE_kmod-ath=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k-common=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic=y" >> .config
        echo "CONFIG_PACKAGE_hostapd-common=y" >> .config
        echo "CONFIG_PACKAGE_iw=y" >> .config
        echo "CONFIG_PACKAGE_iwinfo=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        echo "CONFIG_PACKAGE_iptables=y" >> .config
        echo "# CONFIG_PACKAGE_dnsmasq-full is not set" >> .config
        echo "# CONFIG_PACKAGE_firewall4 is not set" >> .config
        echo "# CONFIG_PACKAGE_nftables is not set" >> .config
        echo "# CONFIG_PACKAGE_ppp-mod-pppoe is not set" >> .config
        echo "# CONFIG_PACKAGE_luci is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-base is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-compat is not set" >> .config
        echo "# CONFIG_PACKAGE_uhttpd is not set" >> .config
        
        # 应用配置
        make defconfig
        
        # 创建自定义配置文件
        mkdir -p files/etc/config
        
        # network配置 - 使用简单的echo
        echo "config interface 'loopback'" > files/etc/config/network
        echo "    option ifname 'lo'" >> files/etc/config/network
        echo "    option proto 'static'" >> files/etc/config/network
        echo "    option ipaddr '127.0.0.1'" >> files/etc/config/network
        echo "    option netmask '255.0.0.0'" >> files/etc/config/network
        echo "" >> files/etc/config/network
        echo "config interface 'lan'" >> files/etc/config/network
        echo "    option ifname 'eth0'" >> files/etc/config/network
        echo "    option proto 'static'" >> files/etc/config/network
        echo "    option ipaddr '192.168.1.1'" >> files/etc/config/network
        echo "    option netmask '255.255.255.0'" >> files/etc/config/network
        
        # wireless配置 - 使用简单的echo
        echo "config wifi-device 'radio0'" > files/etc/config/wireless
        echo "    option type 'mac80211'" >> files/etc/config/wireless
        echo "    option channel '11'" >> files/etc/config/wireless
        echo "    option hwmode '11g'" >> files/etc/config/wireless
        echo "    option path 'platform/ar933x_wmac'" >> files/etc/config/wireless
        echo "    option htmode 'HT20'" >> files/etc/config/wireless
        echo "    option disabled '0'" >> files/etc/config/wireless
        echo "    option txpower '20'" >> files/etc/config/wireless
        echo "" >> files/etc/config/wireless
        echo "config wifi-iface 'default_radio0'" >> files/etc/config/wireless
        echo "    option device 'radio0'" >> files/etc/config/wireless
        echo "    option network 'lan'" >> files/etc/config/wireless
        echo "    option mode 'ap'" >> files/etc/config/wireless
        echo "    option ssid 'TP-WR703N-ImmortalWrt'" >> files/etc/config/wireless
        echo "    option encryption 'psk2'" >> files/etc/config/wireless
        echo "    option key '12345678'" >> files/etc/config/wireless
        
        # 配置验证
        echo "=== 配置验证 ==="
        echo "设备: TP-WR703N 已选中"
        echo "固件: 将生成 squashfs-sysupgrade 固件"
        echo "网络: 唯一网口 eth0 作为 LAN, IP: 192.168.1.1"
        echo "无线: 已启用, SSID: TP-WR703N-ImmortalWrt"
        echo "体积: 目标16MB固件"
    
    - name: Build with multi-threading
      run: |
        cd openwrt
        
        # 设置编译线程数
        MAKE_JOBS=4
        
        # 启用ccache
        export CCACHE_DIR=~/.ccache
        export CCACHE_MAXSIZE=2G
        export CCACHE_COMPRESS=1
        
        echo "使用 $MAKE_JOBS 个线程进行编译"
        
        # 开始编译 - 使用多线程
        time make -j$MAKE_JOBS V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ $? -eq 0 ]; then
          echo "✅ 编译成功"
        else
          echo "❌ 编译失败"
          exit 1
        fi
    
    - name: Check artifacts
      run: |
        cd openwrt
        
        echo "=== 查找固件文件 ==="
        find bin/targets -name "*.bin" -type f | grep -i wr703n || true
        
        # 检查固件
        for file in bin/targets/ath79/tiny/*.bin; do
          if [ -f "$file" ]; then
            echo "找到固件: $file"
            ls -lh "$file"
          fi
        done
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-wr703n
        path: |
          openwrt/bin/targets/**/*.bin
          openwrt/build.log
        retention-days: 7
