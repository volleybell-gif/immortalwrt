name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch:
    inputs:
      enable_cache:
        description: 'Enable CCache for faster builds'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      clean_build:
        description: 'Perform clean build'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  TARGET: ar71xx
  SUBTARGET: generic
  PROFILE: tl-wr841n-v11
  FLASH_SIZE: 16
  RAM_SIZE: 64

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: custom-configs
          
      - name: Setup cache
        if: ${{ github.event.inputs.enable_cache == 'true' }}
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/ccache
            ${{ github.workspace }}/dl
          key: ${{ runner.os }}-immortalwrt-${{ env.TARGET }}-${{ hashFiles('custom-configs/scripts/*.sh', 'custom-configs/config/**') }}
          restore-keys: |
            ${{ runner.os }}-immortalwrt-${{ env.TARGET }}-
            ${{ runner.os }}-immortalwrt-
            
      - name: Install dependencies
        run: |
          echo "Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ccache \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            git \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            python3 \
            python3-setuptools \
            rsync \
            swig \
            unzip \
            zlib1g-dev \
            file \
            wget \
            quilt \
            upx \
            libelf-dev \
            libfdt-dev \
            lzma \
            lzop \
            xsltproc \
            docbook-xsl \
            docbook-xml \
            xmlto \
            re2c
            
      - name: Setup CCache
        if: ${{ github.event.inputs.enable_cache == 'true' }}
        run: |
          echo "Setting up CCache..."
          mkdir -p /tmp/ccache
          echo "CCACHE_DIR=/tmp/ccache" >> $GITHUB_ENV
          ccache --zero-stats
          
      - name: Clone ImmortalWrt source
        run: |
          echo "Cloning ImmortalWrt source..."
          git clone --depth=1 -b openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git
          
      - name: Update feeds
        run: |
          echo "Updating feeds..."
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
      - name: Apply custom configurations
        run: |
          echo "Applying custom configurations..."
          cd immortalwrt
          
          if [ -f ../custom-configs/scripts/customize.sh ]; then
            chmod +x ../custom-configs/scripts/customize.sh
            ../custom-configs/scripts/customize.sh
          fi
          
          if [ -d ../custom-configs/config ]; then
            mkdir -p files/etc/config
            cp -rf ../custom-configs/config/* files/etc/config/ || true
          fi
          
      - name: Clean build (optional)
        if: ${{ github.event.inputs.clean_build == 'true' }}
        run: |
          echo "Cleaning build directory..."
          cd immortalwrt
          make clean
          
      - name: Configure build
        run: |
          echo "Configuring build..."
          cd immortalwrt
          
          make defconfig
          
          # Apply AR9331 specific configuration
          cat >> .config << 'EOF'
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tl-wr841-v11=y
CONFIG_TARGET_KERNEL_PARTSIZE=4
CONFIG_TARGET_ROOTFS_PARTSIZE=12
CONFIG_TARGET_ar71xx_generic_DEVICE_tl-wr841-v11_64M=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_SQUASHFS_BLOCK_SIZE=256
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath9k-common=y
CONFIG_PACKAGE_kmod-ath9k-htc=y
CONFIG_ATH_USER_REGD=y
CONFIG_CCACHE=y
CONFIG_CCACHE_DIR="/tmp/ccache"
CONFIG_BUILD_LOG=y
EOF
          
          make defconfig
          
      - name: Download packages
        run: |
          echo "Downloading packages..."
          cd immortalwrt
          make -j$(($(nproc) * 2)) download || make -j1 download V=s
          
      - name: Build firmware
        run: |
          echo "Building firmware..."
          cd immortalwrt
          
          CORES=$(nproc)
          echo "Using $CORES cores"
          
          if [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
            make -j$CORES V=s
          else
            make -j$CORES V=s
          fi
          
          if [ $? -ne 0 ]; then
            echo "Parallel build failed, trying single core..."
            make -j1 V=s
          fi
          
      - name: Collect firmware files
        run: |
          echo "Collecting firmware files..."
          mkdir -p firmware_output
          
          find immortalwrt/bin/targets -type f \( -name "*squashfs*sysupgrade*" -o -name "*factory*" \) | while read file; do
            echo "Found: $(basename "$file")"
            cp "$file" firmware_output/
          done
          
          echo "Files in firmware_output:"
          ls -la firmware_output/ 2>/dev/null || echo "No files found"
          
      - name: Show CCache stats
        if: ${{ github.event.inputs.enable_cache == 'true' }}
        run: |
          echo "CCache statistics:"
          ccache -s || echo "CCache not available"
          
      - name: Upload firmware artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-AR9331-Firmware
          path: firmware_output/
          retention-days: 30
          
      - name: Build summary
        if: always()
        run: |
          echo "Build Summary"
          echo "============="
          echo "Target: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
          echo "Profile: ${{ env.PROFILE }}"
          echo "Flash: ${{ env.FLASH_SIZE }}MB"
          echo "RAM: ${{ env.RAM_SIZE }}MB"
          echo "CCache: ${{ github.event.inputs.enable_cache }}"
          echo "Clean Build: ${{ github.event.inputs.clean_build }}"
