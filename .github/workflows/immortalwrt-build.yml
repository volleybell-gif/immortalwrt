name: Build ImmortalWrt AR9331

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: immortalwrt-ar9331
  CONFIG_FILE: .config

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          xsltproc \
          zlib1g-dev \
          wget \
          unzip \
          gperf \
          bison \
          flex
        
        # 安装 python3-distutils 的替代方案
        sudo apt-get install -y python3-distutils-extra || true
        python3 -m pip install --upgrade pip setuptools wheel
        
        # 设置 ccache
        sudo apt-get install -y ccache
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        ccache -M 5G
        ccache -s
    
    - name: Clone ImmortalWrt Source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git openwrt -b openwrt-21.02
        cd openwrt
        
        # 更新 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 复制配置文件
        cp ../$CONFIG_FILE .
        
        # 应用自定义配置脚本
        if [ -f ../scripts/configure.sh ]; then
          chmod +x ../scripts/configure.sh
          ../scripts/configure.sh
        fi
        
        # 应用设备树补丁
        if [ -f ../scripts/patch-dts.sh ] && [ -d target/linux/ath79/dts ]; then
          chmod +x ../scripts/patch-dts.sh
          cp ../scripts/patch-dts.sh .
          ./patch-dts.sh
        fi
        
        # 应用配置
        make defconfig
        
        # 显示最终配置
        echo "=== Final .config ==="
        head -50 .config
    
    - name: Build Firmware
      run: |
        cd openwrt
        
        # 使用所有可用的CPU核心进行编译
        THREADS=$(( $(nproc) + 1 ))
        echo "Using $THREADS threads for compilation"
        
        # 启用详细输出以便调试
        make -j$THREADS V=s 2>&1 | tee build.log || {
          echo "Build failed, checking log..."
          tail -100 build.log
          exit 1
        }
        
        # 检查编译结果
        echo "=== Build Results ==="
        find bin/targets -name "*.bin" -type f | head -20
        
        # 复制生成的固件到容易访问的位置
        if [ -d bin/targets/ath79/generic ]; then
          mkdir -p ../firmware
          cp bin/targets/ath79/generic/*squashfs-sysupgrade*.bin ../firmware/
          echo "Firmware files copied to ../firmware/"
          ls -la ../firmware/
        fi
    
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.IMAGE_NAME }}-firmware
        path: firmware/*.bin
        if-no-files-found: error
    
    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: openwrt/build.log
