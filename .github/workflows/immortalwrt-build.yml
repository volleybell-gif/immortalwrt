name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch:
    inputs:
      enable_cache:
        description: 'Enable CCache'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      clean_build:
        description: 'Clean build'
        required: true
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  TARGET: ar71xx
  SUBTARGET: generic
  PROFILE: tl-wr841n-v11
  FLASH_SIZE: 16
  RAM_SIZE: 64

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: custom-configs
        
    - name: Setup cache
      if: ${{ github.event.inputs.enable_cache == 'true' }}
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/ccache
          ${{ github.workspace }}/dl
        key: ${{ runner.os }}-immortalwrt-${{ env.TARGET }}
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libncursesw5-dev libssl-dev python3 python3-setuptools rsync swig unzip zlib1g-dev file wget
        
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 -b openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git
        
    - name: Update feeds
      run: |
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Apply custom configurations
      run: |
        cd immortalwrt
        
        if [ -f ../custom-configs/scripts/customize.sh ]; then
          chmod +x ../custom-configs/scripts/customize.sh
          ../custom-configs/scripts/customize.sh
        fi
        
    - name: Clean build
      if: ${{ github.event.inputs.clean_build == 'true' }}
      run: |
        cd immortalwrt
        make clean
        
    - name: Configure build
      run: |
        cd immortalwrt
        make defconfig
        
        echo 'CONFIG_TARGET_ar71xx=y' >> .config
        echo 'CONFIG_TARGET_ar71xx_generic=y' >> .config
        echo 'CONFIG_TARGET_ar71xx_generic_DEVICE_tl-wr841-v11=y' >> .config
        echo 'CONFIG_TARGET_KERNEL_PARTSIZE=4' >> .config
        echo 'CONFIG_TARGET_ROOTFS_PARTSIZE=12' >> .config
        echo 'CONFIG_TARGET_ROOTFS_SQUASHFS=y' >> .config
        echo 'CONFIG_TARGET_SQUASHFS_BLOCK_SIZE=256' >> .config
        echo 'CONFIG_PACKAGE_kmod-ath9k=y' >> .config
        echo 'CONFIG_CCACHE=y' >> .config
        
        make defconfig
        
    - name: Download packages
      run: |
        cd immortalwrt
        make download -j$(nproc)
        
    - name: Build firmware
      run: |
        cd immortalwrt
        make -j$(nproc) V=s
        
    - name: Collect firmware files
      run: |
        mkdir -p firmware_output
        find immortalwrt/bin/targets -type f -name "*.bin" | head -10 | while read file; do
          echo "Found: $(basename "$file")"
          cp "$file" firmware_output/
        done
        
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: firmware_output/
