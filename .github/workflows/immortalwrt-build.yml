
name: ImmortalWrt Cloud Build

on:
  workflow_dispatch:
    inputs:
      enable_cache:
        description: '启用缓存加速'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: 初始化环境
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget

      - name: 设置缓存
        if: ${{ github.event.inputs.enable_cache == 'true' }}
        uses: actions/cache@v3
        with:
          path: ~/cache
          key: immortalwrt-cache-${{ github.run_id }}

      - name: 下载源码
        run: |
          git clone -b openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git immortalwrt
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 复制自定义配置
        run: |
          cp -rf ./config/* immortalwrt/
          chmod +x ./scripts/*.sh
          ./scripts/customize.sh

      - name: 构建固件
        run: |
          cd immortalwrt
          make defconfig
          make download -j$(nproc)
          make -j$(nproc) V=s

      - name: 整理输出文件
        run: |
          mkdir -p ./firmware
          cp -rf immortalwrt/bin/targets/*/* ./firmware/

      - name: 上传固件
        uses: actions/upload-artifact@v3
        with:
          name: ImmortalWrt固件
          path: ./firmware/
