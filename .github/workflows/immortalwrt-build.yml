name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch:
    inputs:
      enable_cache:
        description: '启用缓存加速'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      clean_build:
        description: '是否完全清理构建'
        required: true
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  TARGET: ar71xx
  SUBTARGET: generic
  PROFILE: tl-wr841n-v11
  FLASH_SIZE: 16
  RAM_SIZE: 64
  CCACHE_DIR: /tmp/ccache
  DL_DIR: ${{ github.workspace }}/dl
  CCACHE_MAXSIZE: 2G

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出仓库代码
      uses: actions/checkout@v4
      with:
        path: custom-configs
        
    - name: 设置缓存
      if: ${{ github.event.inputs.enable_cache == 'true' }}
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/ccache
          ${{ github.workspace }}/dl
        key: ${{ runner.os }}-immortalwrt-${{ env.TARGET }}-${{ hashFiles('custom-configs/scripts/*.sh', 'custom-configs/config/**') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-${{ env.TARGET }}-
          ${{ runner.os }}-immortalwrt-
          
    - name: 安装依赖包
      run: |
        echo "========================================"
        echo "正在安装构建依赖..."
        echo "========================================"
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          git \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-setuptools \
          rsync \
          swig \
          unzip \
          zlib1g-dev \
          file \
          wget \
          quilt \
          upx \
          libelf-dev \
          libfdt-dev \
          lzma \
          lzop \
          xsltproc \
          docbook-xsl \
          docbook-xml \
          xmlto \
          re2c
        
    - name: 设置CCache缓存
      if: ${{ github.event.inputs.enable_cache == 'true' }}
      run: |
        echo "========================================"
        echo "正在设置CCache缓存..."
        echo "========================================"
        mkdir -p ${{ env.CCACHE_DIR }}
        echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=${{ env.CCACHE_MAXSIZE }}" >> $GITHUB_ENV
        ccache --zero-stats
        
    - name: 克隆ImmortalWrt源码
      run: |
        echo "========================================"
        echo "正在克隆ImmortalWrt源码..."
        echo "========================================"
        git clone --depth=1 -b openwrt-21.02 https://github.com/immortalwrt/immortalwrt.git immortalwrt
        
    - name: 更新和安装Feeds
      run: |
        echo "========================================"
        echo "正在更新feeds..."
        echo "========================================"
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: 应用自定义配置
      run: |
        echo "========================================"
        echo "正在应用自定义配置..."
        echo "========================================"
        cd immortalwrt
        
        # 应用自定义脚本
        if [ -f ../custom-configs/scripts/customize.sh ]; then
          chmod +x ../custom-configs/scripts/customize.sh
          ../custom-configs/scripts/customize.sh
        fi
        
        # 复制配置文件
        if [ -d ../custom-configs/config ]; then
          mkdir -p files/etc/config
          cp -rf ../custom-configs/config/* files/etc/config/ || true
        fi
        
    - name: 清理构建（可选）
      if: ${{ github.event.inputs.clean_build == 'true' }}
      run: |
        echo "========================================"
        echo "正在清理构建目录..."
        echo "========================================"
        cd immortalwrt
        make clean
        
    - name: 配置构建参数
      run: |
        echo "========================================"
        echo "正在配置构建参数..."
        echo "========================================"
        cd immortalwrt
        
        # 生成默认配置
        make defconfig
        
        # 应用AR9331特定配置（16MB Flash）
        cat >> .config << 'EOF'
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tl-wr841-v11=y

# 设置正确的闪存分区大小
CONFIG_TARGET_KERNEL_PARTSIZE=4
CONFIG_TARGET_ROOTFS_PARTSIZE=12

# 启用64MB内存支持
CONFIG_TARGET_ar71xx_generic_DEVICE_tl-wr841-v11_64M=y

# 文件系统
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_SQUASHFS_BLOCK_SIZE=256

# 无线驱动
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath9k-common=y
CONFIG_PACKAGE_kmod-ath9k-htc=y
CONFIG_ATH_USER_REGD=y

# CCache优化
CONFIG_CCACHE=y
CONFIG_CCACHE_DIR="${{ env.CCACHE_DIR }}"
CONFIG_BUILD_LOG=y
EOF
        
        # 最终确定配置
        make defconfig
        
    - name: 下载软件包
      run: |
        echo "========================================"
        echo "正在下载软件包..."
        echo "========================================"
        cd immortalwrt
        
        # 使用并行下载
        make -j$(($(nproc) * 2)) download || make -j1 download V=s
        
    - name: 构建固件
      run: |
        echo "========================================"
        echo "正在构建固件..."
        echo "========================================"
        cd immortalwrt
        
        # 获取CPU核心数
        CORES=$(nproc)
        echo "使用 $CORES 个核心进行编译"
        
        # 根据是否启用缓存选择构建方式
        if [ "${{ github.event.inputs.enable_cache }}" = "true" ]; then
          echo "使用CCache加速构建"
          make -j$CORES V=s CCACHE_DIR="${{ env.CCACHE_DIR }}"
        else
          echo "不使用CCache构建"
          make -j$CORES V=s
        fi
        
        # 如果并行构建失败，尝试单核心构建
        if [ $? -ne 0 ]; then
          echo "并行构建失败，尝试单核心构建..."
          make -j1 V=s
        fi
        
    - name: 收集固件文件
      run: |
        echo "========================================"
        echo "正在收集固件文件..."
        echo "========================================"
        
        # 创建输出目录
        mkdir -p firmware_output
        
        # 查找并复制固件文件
        find immortalwrt/bin/targets -type f \( -name "*squashfs*sysupgrade*" -o -name "*factory*" \) | while read file; do
          echo "找到固件: $(basename "$file")"
          cp "$file" firmware_output/
        done
        
        # 列出所有收集的文件
        echo "已收集的固件文件:"
        ls -la firmware_output/ || echo "未找到文件"
        
    - name: 显示CCache统计
      if: ${{ github.event.inputs.enable_cache == 'true' }}
      run: |
        echo "========================================"
        echo "CCache统计信息:"
        echo "========================================"
        ccache -s || echo "CCache不可用"
        
    - name: 上传固件工件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt-AR9331-固件
        path: firmware_output/
        retention-days: 30
        
    - name: 构建总结
      if: always()
      run: |
        echo "========================================"
        echo "构建总结:"
        echo "========================================"
        echo "目标平台: ${{ env.TARGET }}/${{ env.SUBTARGET }}"
        echo "设备型号: ${{ env.PROFILE }}"
        echo "闪存大小: ${{ env.FLASH_SIZE }}MB"
        echo "内存大小: ${{ env.RAM_SIZE }}MB"
        echo "CCache启用: ${{ github.event.inputs.enable_cache }}"
        echo "清理构建: ${{ github.event.inputs.clean_build }}"
        echo "========================================"
