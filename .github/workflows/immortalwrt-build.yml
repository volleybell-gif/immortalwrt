name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch: # 允许手动触发
  push:
    branches: [ main, master ]
  schedule:
    # 可选：每周日凌晨自动编译，保持代码最新
    - cron: '0 0 * * 0'

env:
  TARGET: ath79
  SUBTARGET: tiny
  PROFILE: tplink_tl-wr703n-v1 # 与AR9331 64+16配置兼容的常见型号

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: main-repo  # 将主仓库克隆到子目录，避免与源码目录混淆

      - name: Setup ccache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ env.TARGET }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ env.TARGET }}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          echo "安装编译依赖..."
          sudo apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
          g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
          libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev \
          libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano \
          ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
          python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs \
          upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd

      - name: Clone ImmortalWrt source (21.02 branch)
        run: |
          git clone -b openwrt-21.02 --single-branch --depth=1 https://github.com/immortalwrt/immortalwrt.git immortalwrt-source
          cd immortalwrt-source
          echo "源码克隆完成"

      - name: Run custom configuration script
        run: |
          # 从主仓库复制配置脚本
          cp -v main-repo/scripts/configure.sh immortalwrt-source/
          cd immortalwrt-source
          chmod +x configure.sh
          ./configure.sh

      - name: Apply custom config files
        run: |
          echo "应用自定义配置文件..."
          
          # 创建目标目录
          mkdir -p immortalwrt-source/files/etc/config
          
          # 从主仓库复制配置文件到ImmortalWrt的files目录
          cp -v main-repo/config/network immortalwrt-source/files/etc/config/
          cp -v main-repo/config/wireless immortalwrt-source/files/etc/config/
          cp -v main-repo/config/firewall immortalwrt-source/files/etc/config/
          
          echo "配置文件已复制到 immortalwrt-source/files/etc/config/"
          ls -la immortalwrt-source/files/etc/config/

      - name: Update and install feeds
        run: |
          cd immortalwrt-source
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "Feeds更新完成"

      - name: Download packages
        run: |
          cd immortalwrt-source
          make download -j$(nproc) V=s
          echo "源码包下载完成"

      - name: Build firmware (with ccache)
        run: |
          cd immortalwrt-source
          # 启用ccache和多线程编译以极大提升速度
          export CCACHE_DIR=~/.ccache
          export CCACHE_MAXSIZE=2G
          make -j$(nproc) V=s CCACHE=1
          echo "固件构建完成"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-ar9331-firmware
          path: immortalwrt-source/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/openwrt-*.squashfs-sysupgrade.bin
          retention-days: 7
        if: success()
