name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-21.02
  FEEDS_CONF: feeds.conf.default

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        path: config_files

    - name: Set up Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget curl ccache
        echo "Environment setup completed"

    - name: Checkout ImmortalWrt Source
      run: |
        git clone --depth=1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
        echo "Source code cloned"

    - name: Copy Custom Files
      run: |
        cd openwrt
        if [ -f ../config_files/${{ env.FEEDS_CONF }} ]; then
          cp ../config_files/${{ env.FEEDS_CONF }} .
        fi
        if [ -d ../config_files/scripts ]; then
          cp -rf ../config_files/scripts/* scripts/
          chmod +x scripts/*.sh
        fi
        if [ -d ../config_files/files ]; then
          cp -rf ../config_files/files/* files/
        fi

    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Default Configuration
      run: |
        cd openwrt
        cat > .config << 'EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_generic=y
CONFIG_TARGET_ath79_generic_DEVICE_tplink_tl-mr3420-v2=y
CONFIG_TARGET_ROOTFS_PARTSIZE=16
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_DEVEL=y
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
EOF
        echo "Default configuration loaded"

    - name: Run Custom Configuration Script
      run: |
        cd openwrt
        if [ -f scripts/configure.sh ]; then
          chmod +x scripts/configure.sh
          ./scripts/configure.sh
        fi

    - name: Load Custom Configuration
      run: |
        cd openwrt
        cat >> .config << 'EOF'
# Network configuration
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y

# Wireless drivers
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath9k-common=y
CONFIG_PACKAGE_kmod-cfg80211=y
CONFIG_PACKAGE_kmod-mac80211=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y

# Basic tools
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_wget=y
CONFIG_PACKAGE_ip-full=y

# Disable debug to save space
CONFIG_KERNEL_KALLSYMS=n
CONFIG_KERNEL_DEBUG_FS=n
CONFIG_KERNEL_DEBUG_INFO=n
EOF

    - name: Configure with defconfig
      run: |
        cd openwrt
        make defconfig

    - name: Download Dependencies
      run: |
        cd openwrt
        make download -j$(nproc)
        echo "Dependencies downloaded"

    - name: Build Firmware
      run: |
        cd openwrt
        export CCACHE_DIR="${{ github.workspace }}/ccache"
        export CCACHE_MAXSIZE=2G
        mkdir -p $CCACHE_DIR
        make -j$(($(nproc) + 1)) V=s || make -j1 V=s

    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: immortalwrt-ar9331-firmware
        path: openwrt/bin/targets/ath79/generic/*squashfs-sysupgrade.bin

    - name: Upload ccache
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ccache
        path: ccache
