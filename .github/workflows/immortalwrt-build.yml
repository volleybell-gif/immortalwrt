name: Build ImmortalWrt AR9331

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

env:
  IMAGE_NAME: immortalwrt-ar9331
  CONFIG_FILE: .config

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        threads: [4]
      fail-fast: false
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          xsltproc \
          zlib1g-dev \
          wget
    
    - name: Configure CCache
      run: |
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        ccache -M 5G
        ccache -s
    
    - name: Clone ImmortalWrt Source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git openwrt -b openwrt-21.02
        cd openwrt
        
        # 更新 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 应用自定义配置
        if [ -f ../scripts/configure.sh ]; then
          chmod +x ../scripts/configure.sh
          ../scripts/configure.sh
        fi
        
        # 应用设备树补丁
        if [ -f ../scripts/patch-dts.sh ]; then
          chmod +x ../scripts/patch-dts.sh
          cd target/linux/ath79/dts
          ../../../../../scripts/patch-dts.sh
          cd ../../../../..
        fi
        
        # 复制默认配置
        cp ../$CONFIG_FILE .
        
        # 应用配置并检查
        make defconfig
        make -j$(nproc) kernel_oldconfig
    
    - name: Build Firmware
      run: |
        cd openwrt
        
        # 设置编译线程数
        THREADS=$(( $(nproc) * 2 ))
        echo "Using $THREADS threads for compilation"
        
        # 开始编译
        make -j$THREADS
        
        # 检查编译结果
        if [ -d bin/targets/ath79/generic ]; then
          echo "Build successful!"
          ls -la bin/targets/ath79/generic/*.bin
        else
          echo "Build failed!"
          exit 1
        fi
    
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.IMAGE_NAME }}-firmware
        path: openwrt/bin/targets/ath79/generic/*squashfs-sysupgrade*.bin
