name: Build ImmortalWrt for AR9331

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build (no cache)'
        required: false
        default: 'false'

env:
  BUILD_THREADS: 8
  CCACHE_DIR: /tmp/ccache
  CCACHE_MAXSIZE: 2G
  TARGET_BOARD: ar71xx
  TARGET_SUBTARGET: tiny
  TARGET_PROFILE: generic

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget \
          ccache nano time python3 python3-setuptools \
          python3-dev curl libelf-dev
    
    - name: Setup ccache
      uses: actions/cache@v3
      with:
        path: /tmp/ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('scripts/configure.sh', 'config/**', 'scripts/patch-dts.sh') }}
        restore-keys: |
          ${{ runner.os }}-ccache-
    
    - name: Clone ImmortalWrt source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b openwrt-21.02 openwrt
        cd openwrt
        
        # 应用自定义配置
        cp -rf ../scripts/configure.sh ./
        cp -rf ../scripts/patch-dts.sh ./
        chmod +x ./configure.sh ./patch-dts.sh
        
        # 应用配置脚本
        ./configure.sh
        
        # 应用设备树补丁
        if [ -f "../config/dts-overlay/ar9331-custom.dts" ]; then
          ./patch-dts.sh
        fi
        
        # 复制网络配置文件
        mkdir -p files/etc/config
        cp ../config/network files/etc/config/
        cp ../config/wireless files/etc/config/
        cp ../config/firewall files/etc/config/
        
        # 确保必要的目录存在
        mkdir -p files/etc/uci-defaults
        
        # 设置默认配置
        cat > files/etc/uci-defaults/99-custom << 'EOF'
        #!/bin/sh
        
        # 设置LAN口IP
        uci set network.lan.ipaddr='192.168.1.1'
        uci commit network
        
        # 设置无线SSID和密码（如果需要）
        # uci set wireless.@wifi-iface[0].ssid='ImmortalWrt-AR9331'
        # uci set wireless.@wifi-iface[0].key='yourpassword'
        # uci commit wireless
        
        exit 0
        EOF
        
        chmod +x files/etc/uci-defaults/99-custom
    
    - name: Build firmware
      run: |
        cd openwrt
        
        # 设置编译环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_UMASK=002
        export CCACHE_MAXSIZE=2G
        
        # 多线程编译
        echo "开始编译，使用 $BUILD_THREADS 个线程"
        
        # 清理之前的编译（可选）
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "执行清理编译..."
          make clean
          rm -rf tmp
          rm -rf .config
        fi
        
        # 确保.config存在
        if [ ! -f .config ]; then
          make defconfig
        fi
        
        # 应用精简配置
        ./scripts/diffconfig.sh > diffconfig
        echo "当前配置差异："
        cat diffconfig
        
        # 下载所有依赖
        echo "下载依赖..."
        make -j$BUILD_THREADS download
        
        # 检查依赖是否完整
        find dl -size 0 -delete
        
        # 重新下载失败的包
        make -j$BUILD_THREADS download
        
        # 编译工具链
        echo "编译工具链..."
        make -j$BUILD_THREADS tools/compile
        
        # 编译目标
        echo "编译固件..."
        time make -j$BUILD_THREADS V=s
        
        echo "编译完成！检查输出文件..."
        
        # 检查生成的固件
        if ls bin/targets/ar71xx/tiny/*.bin 2>/dev/null; then
          echo "固件生成成功！"
          ls -lh bin/targets/ar71xx/tiny/*.bin
        else
          echo "错误：未找到生成的固件文件"
          exit 1
        fi
    
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: immortalwrt-ar9331-firmware
        path: |
          openwrt/bin/targets/ar71xx/tiny/
        retention-days: 7
