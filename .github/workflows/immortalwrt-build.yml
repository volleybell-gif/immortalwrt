name: Build ImmortalWrt AR9331

on:
  workflow_dispatch:
  push:
    branches: [main, master]

env:
  BUILD_THREADS: 4
  CCACHE_DIR: /tmp/ccache

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget \
          ccache time python3 python3-setuptools \
          python3-dev curl libelf-dev xsltproc

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: /tmp/ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Clone ImmortalWrt
      run: |
        echo "克隆 ImmortalWrt 21.02..."
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b openwrt-21.02 openwrt
        
        echo "复制配置文件和脚本..."
        # 复制脚本
        cp scripts/*.sh openwrt/
        chmod +x openwrt/*.sh
        
        # 复制配置文件
        mkdir -p openwrt/files/etc/config
        cp config/network openwrt/files/etc/config/
        cp config/wireless openwrt/files/etc/config/
        cp config/firewall openwrt/files/etc/config/
        
        # 复制设备树文件
        if [ -f "config/dts-overlay/ar9331-custom.dts" ]; then
          mkdir -p openwrt/custom-dts
          cp config/dts-overlay/ar9331-custom.dts openwrt/custom-dts/
        fi

    - name: Configure and patch
      run: |
        cd openwrt
        echo "当前目录: $(pwd)"
        echo "目录内容:"
        ls -la
        
        echo "运行配置脚本..."
        ./configure.sh
        
        echo "检查配置..."
        echo "目标架构:"
        grep "CONFIG_TARGET" .config
        echo ""
        echo "包配置:"
        grep "CONFIG_PACKAGE" .config | head -20
        
        echo "运行设备树补丁脚本..."
        ./patch-dts.sh || echo "设备树补丁可能未应用，继续..."

    - name: Download sources
      run: |
        cd openwrt
        echo "下载依赖..."
        make -j$BUILD_THREADS download 2>&1 | tail -50
        
        echo "检查目标目录..."
        ls -la target/linux/ar71xx/

    - name: Build firmware
      run: |
        cd openwrt
        
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_MAXSIZE=2G
        
        echo "开始编译 AR9331 固件..."
        echo "当前配置目标:"
        grep "TARGET" .config
        
        # 只编译目标，不编译其他架构
        time make -j$BUILD_THREADS V=s 2>&1 | tee build.log
        
        echo "编译完成，检查输出..."
        echo "查找固件文件..."
        find bin/ -name "*.bin" -o -name "*.bin.gz" 2>/dev/null | head -20
        
        if ls -la bin/targets/ar71xx/tiny/*.bin 2>/dev/null; then
          echo "✓ 固件生成成功！"
          echo "生成的固件:"
          ls -lh bin/targets/ar71xx/tiny/*.bin
          echo "文件大小:"
          du -h bin/targets/ar71xx/tiny/*.bin
        else
          echo "✗ 错误：未找到生成的固件"
          echo "可能的原因:"
          echo "1. 目标架构配置不正确"
          echo "2. 编译过程中出现错误"
          echo "查看构建日志最后100行..."
          tail -100 build.log
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: immortalwrt-ar9331-firmware
        path: |
          openwrt/bin/targets/ar71xx/tiny/*.bin
          openwrt/bin/targets/ar71xx/tiny/*.gz
        retention-days: 7
