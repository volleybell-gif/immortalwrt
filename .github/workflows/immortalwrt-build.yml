name: Build ImmortalWrt AR9331

on:
  workflow_dispatch:
  push:
    branches: [main, master]

env:
  BUILD_THREADS: 4
  CCACHE_DIR: /tmp/ccache

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget \
          ccache time python3 python3-setuptools \
          python3-dev curl libelf-dev xsltproc

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: /tmp/ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('scripts/*.sh', 'config/**') }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Clone ImmortalWrt
      run: |
        echo "克隆 ImmortalWrt 21.02..."
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b openwrt-21.02 openwrt
        
        echo "复制配置文件..."
        mkdir -p openwrt/files/etc/config
        cp config/network openwrt/files/etc/config/
        cp config/wireless openwrt/files/etc/config/
        cp config/firewall openwrt/files/etc/config/
        
        if [ -f "config/dts-overlay/ar9331-custom.dts" ]; then
          mkdir -p openwrt/custom-dts
          cp config/dts-overlay/ar9331-custom.dts openwrt/custom-dts/
        fi
        
        echo "复制构建脚本..."
        cp scripts/*.sh openwrt/
        chmod +x openwrt/*.sh

    - name: Configure build
      run: |
        cd openwrt
        echo "运行配置脚本..."
        ./configure.sh
        echo "运行设备树补丁脚本..."
        ./patch-dts.sh

    - name: Download sources
      run: |
        cd openwrt
        echo "下载依赖..."
        make -j$BUILD_THREADS download 2>&1 | tail -50
        echo "清理空的下载文件..."
        find dl -size 0 -delete -print

    - name: Build firmware
      run: |
        cd openwrt
        
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR=/tmp/ccache
        export CCACHE_MAXSIZE=2G
        
        echo "开始编译 AR9331 固件..."
        echo "目标: ar71xx/tiny"
        echo "线程数: $BUILD_THREADS"
        
        # 生成默认配置
        make defconfig
        
        # 编译
        time make -j$BUILD_THREADS V=sc 2>&1 | tail -100
        
        echo "编译完成，检查输出..."
        ls -la bin/targets/ar71xx/tiny/ || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: immortalwrt-ar9331
        path: |
          openwrt/bin/targets/ar71xx/tiny/*.bin
          openwrt/bin/targets/ar71xx/tiny/*.gz
        retention-days: 7
