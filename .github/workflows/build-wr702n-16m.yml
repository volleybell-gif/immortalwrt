name: Build ImmortalWrt for TL-WR702N v1 (16MB)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3
        
    - name: Get source
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git
        
    - name: Make config
      run: |
        cd immortalwrt
        
        # 生成最小配置
        cat > .config << 'EOF'
CONFIG_TARGET_ar71xx=y
CONFIG_TARGET_ar71xx_generic=y
CONFIG_TARGET_ar71xx_generic_DEVICE_tplink_tl-wr702n-v1=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=14080
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_kmod-ath9k=y
EOF
        
    - name: Build
      run: |
        cd immortalwrt
        make defconfig
        make -j2 V=s
