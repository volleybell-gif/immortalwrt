name: Build ImmortalWrt for TL-WR703N

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'æ‰§è¡Œå®Œæ•´æ¸…ç†ç¼–è¯‘'
        required: false
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.6'
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache curl git libncurses5-dev \
        libssl-dev python3 python3-dev python3-distutils meson gperf help2man
        
    - name: Clone ImmortalWrt source
      run: |
        git clone -b openwrt-18.06 --single-branch --depth=1 --filter=blob:none https://github.com/immortalwrt/immortalwrt.git openwrt
        
    - name: Update feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Configure for TL-WR703N (16MB)
      working-directory: ./openwrt
      run: |
        # è®¾ç½®ç›®æ ‡å¹³å°ä¸ºar71xx
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_tiny=y" >> .config
        echo "CONFIG_TARGET_ar71xx_tiny_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        
        # æ–‡ä»¶ç³»ç»Ÿé…ç½® - ç¡®ä¿ç”Ÿæˆsquashfs-sysupgrade
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_EXT4FS=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_JFFS2=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
        
        # åŸºç¡€è½¯ä»¶åŒ…
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        
        # ç¼–è¯‘ä¼˜åŒ–
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        
    - name: Build firmware
      working-directory: ./openwrt
      run: |
        make defconfig
        make -j$(nproc) V=s
        
    - name: Verify firmware
      working-directory: ./openwrt
      run: |
        FIRMWARE_FILE="bin/targets/ar71xx/tiny/immortalwrt-ar71xx-tiny-tl-wr703n-v1-squashfs-sysupgrade.bin"
        if [ -f "$FIRMWARE_FILE" ]; then
          FIRMWARE_SIZE=$(stat -c%s "$FIRMWARE_FILE")
          echo "âœ… å›ºä»¶ç”ŸæˆæˆåŠŸï¼"
          echo "ğŸ“ æ–‡ä»¶ï¼š$FIRMWARE_FILE"
          echo "ğŸ“ å¤§å°ï¼š$FIRMWARE_SIZE bytes"
          if [ $FIRMWARE_SIZE -gt 15728640 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šå›ºä»¶å¤§å°è¶…è¿‡15MBï¼Œå¯èƒ½è¶…å‡º16MBé—ªå­˜é™åˆ¶"
          else
            echo "âœ… å›ºä»¶å¤§å°åœ¨å®‰å…¨èŒƒå›´å†…"
          fi
        else
          echo "âŒ é”™è¯¯ï¼šå›ºä»¶æ–‡ä»¶æœªæ‰¾åˆ°"
          ls -la bin/targets/ar71xx/tiny/
          exit 1
        fi
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-tl-wr703n-v1
        path: openwrt/bin/targets/ar71xx/tiny/
        retention-days: 7
