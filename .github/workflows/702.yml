name: Build ImmortalWrt for TL-WR703N

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      clean_build:
        description: '执行完整清理编译'
        required: false
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache curl git libncurses5-dev \
        libssl-dev python3 python3-pip python3-dev python3-distutils meson gperf help2man
        sudo apt-get clean
        
    - name: Clone ImmortalWrt source
      run: |
        git clone -b openwrt-18.06 --single-branch --depth=1 --filter=blob:none https://github.com/immortalwrt/immortalwrt.git openwrt
        
    - name: Update and install feeds
      working-directory: ./openwrt
      run: |
        timeout 600 ./scripts/feeds update -a
        timeout 300 ./scripts/feeds install -a
        
    - name: Configure for TL-WR703N (16MB)
      working-directory: ./openwrt
      run: |
        # 设置目标平台为ar71xx
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_tiny=y" >> .config
        echo "CONFIG_TARGET_ar71xx_tiny_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        
        # 文件系统配置 - 确保生成squashfs-sysupgrade
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_EXT4FS=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_JFFS2=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
        
        # 基础软件包
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        
        # 编译优化
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
        
        # 禁用调试信息
        echo "CONFIG_KERNEL_KALLSYMS=n" >> .config
        echo "CONFIG_KERNEL_DEBUG_INFO=n" >> .config
        
    - name: Build firmware
      working-directory: ./openwrt
      run: |
        make defconfig
        make -j$(nproc) V=s
        
    - name: Verify firmware generation
      working-directory: ./openwrt
      run: |
        if ls bin/targets/ar71xx/tiny/*tl-wr703n*.bin 1> /dev/null 2>&1; then
          echo "✅ Firmware build successful!"
          echo "Generated files:"
          ls -la bin/targets/ar71xx/tiny/
        else
          echo "❌ Firmware build failed - no output files found"
          exit 1
        fi
        
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-tl-wr703n-v1
        path: openwrt/bin/targets/ar71xx/tiny/
        retention-days: 7
