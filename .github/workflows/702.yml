name: Build ImmortalWrt for TL-WR703N

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      clean_build:
        description: '执行完整清理编译'
        required: false
        default: false

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache curl git libncurses5-dev \
        libssl-dev python3 python3-pip python3-dev python3-distutils meson gperf help2man
        
    - name: Clone ImmortalWrt source
      run: |
        git clone -b openwrt-18.06 --single-branch --depth=1 --filter=blob:none https://github.com/immortalwrt/immortalwrt.git openwrt
        
    - name: Update and install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Configure for TL-WR703N
      working-directory: ./openwrt
      run: |
        echo "CONFIG_TARGET_ar71xx=y" > .config
        echo "CONFIG_TARGET_ar71xx_tiny=y" >> .config
        echo "CONFIG_TARGET_ar71xx_tiny_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
        
        # 基础软件包
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_firewall=y" >> .config
        
    - name: Build firmware
      working-directory: ./openwrt
      run: |
        make defconfig
        make -j$(nproc) V=s
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-tl-wr703n-v1
        path: openwrt/bin/targets/ar71xx/tiny/
        retention-days: 7
