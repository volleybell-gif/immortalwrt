
name: Build ImmortalWrt 23.05.7
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      clean_build:
        description: '执行完整清理编译'
        required: false
        default: false
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache curl git libncurses5-dev \
        libssl-dev python3 python3-pip python3-dev meson gperf help2man
    - name: Clone ImmortalWrt 23.05.7 source
      run: |
        git clone -b v23.05.7 --single-branch --depth=1 --filter=blob:none https://github.com/immortalwrt/immortalwrt.git openwrt
    - name: Update and install feeds
      working-directory: ./openwrt
      run: |
        timeout 600 ./scripts/feeds update -a
        timeout 300 ./scripts/feeds install -a
    - name: Configure for target device
      working-directory: ./openwrt
      run: |
        echo "CONFIG_TARGET_ath79=y" > .config
        echo "CONFIG_TARGET_ath79_generic=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=16" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
    - name: Build firmware
      working-directory: ./openwrt
      run: |
        make defconfig
        make -j$(nproc) V=s
    - name: Verify firmware generation
      working-directory: ./openwrt
      run: |
        if ls bin/targets/ath79/generic/*.bin 1> /dev/null 2>&1; then
          echo "✅ 固件生成成功！"
          ls -la bin/targets/ath79/generic/
        else
          echo "❌ 固件生成失败"
          exit 1
        fi
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-23.05.7
        path: openwrt/bin/targets/ath79/generic/
        retention-days: 7

