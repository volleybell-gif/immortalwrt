name: Build AR9331 Firmware

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['.github/workflows/**']

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: openwrt-21.02
        path: openwrt
        
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache git libssl-dev python3
        
    - name: Configure
      run: |
        cd openwrt
        echo "CONFIG_TARGET_ath79_generic=y" > .config
        echo "CONFIG_TARGET_ath79_generic_DEVICE_tplink_tl-wr703n-v1=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        
    - name: Build
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc)
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: openwrt/bin/targets/ath79/generic/*.bin
