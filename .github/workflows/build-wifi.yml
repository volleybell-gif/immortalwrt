name: Build ImmortalWrt for AR9331

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup build environment
      run: |
        echo "设置编译环境..."
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-distutils \
          python3-setuptools rsync unzip zlib1g-dev file wget subversion quilt \
          gperf bison curl ccache
        echo "环境设置完成"
    
    - name: Setup ccache
      run: |
        echo "设置 ccache 缓存..."
        ccache -M 1G
        ccache -s
    
    - name: Clone source code
      run: |
        echo "克隆 ImmortalWrt 源码..."
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt -b openwrt-21.02 openwrt
        cd openwrt
    
    - name: Create config files
      run: |
        echo "创建配置文件..."
        cd openwrt
        
        # 创建 feeds.conf
        echo "创建 feeds.conf..."
        cat > feeds.conf << 'EOF'
src-git packages https://github.com/immortalwrt/packages;openwrt-21.02
src-git luci https://github.com/immortalwrt/luci;openwrt-21.02
src-git routing https://github.com/openwrt/routing;openwrt-21.02
src-git telephony https://github.com/openwrt/telephony;openwrt-21.02
EOF
        
        # 创建初始 .config
        echo "创建 .config..."
        cat > .config << 'EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_generic=y
CONFIG_TARGET_ath79_generic_DEVICE_tplink_tl-wr841n-v9=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_KERNEL_PARTSIZE=4
CONFIG_TARGET_ROOTFS_PARTSIZE=8
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-ath=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
EOF
        
        # 添加网络配置
        echo "添加网络配置..."
        cat >> .config << 'EOF'
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_ip6tables=y
CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
EOF
        
        echo "配置文件创建完成"
    
    - name: Update and install feeds
      run: |
        echo "更新 feeds..."
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Configure additional packages
      run: |
        echo "配置额外软件包..."
        cd openwrt
        
        # 生成默认配置
        make defconfig
        
        # 配置额外需要的包
        cat >> .config << 'EOF'
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-upnp=y
CONFIG_PACKAGE_autossh=y
CONFIG_PACKAGE_openssh-sftp-server=y
EOF
        
        # 更新配置
        make defconfig
        echo "配置完成"
    
    - name: Download packages
      run: |
        echo "下载软件包..."
        cd openwrt
        make download -j$(nproc)
        echo "下载完成"
    
    - name: Build firmware
      run: |
        echo "开始编译固件..."
        cd openwrt
        
        # 获取核心数
        CORES=$(nproc)
        echo "使用 $CORES 线程编译"
        
        # 编译
        make -j$CORES V=s 2>&1 | tee build.log
        
        echo "编译完成"
    
    - name: Check build result
      run: |
        echo "检查编译结果..."
        if ls openwrt/bin/targets/ath79/generic/*squashfs-sysupgrade.bin 2>/dev/null; then
          echo "固件编译成功！"
          ls -lh openwrt/bin/targets/ath79/generic/*.bin
        else
          echo "未找到固件文件，编译可能失败"
          exit 1
        fi
    
    - name: Upload firmware
      uses: actions/upload-artifact@v3
      with:
        name: immortalwrt-ar9331-16mb
        path: openwrt/bin/targets/ath79/generic/*squashfs-sysupgrade.bin
