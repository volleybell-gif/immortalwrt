#!/bin/sh

# AR9331 首次启动配置脚本
# 这个脚本会在路由器首次启动时执行

echo "=== AR9331 首次启动配置 ==="

# 配置网络
echo "配置网络..."
uci batch << EOF
delete network.wan
delete network.wan6
set network.lan=interface
set network.lan.type='bridge'
set network.lan.ifname='eth0'
set network.lan.proto='static'
set network.lan.ipaddr='192.168.1.1'
set network.lan.netmask='255.255.255.0'
set dhcp.lan=dhcp
set dhcp.lan.interface='lan'
set dhcp.lan.start='100'
set dhcp.lan.limit='150'
set dhcp.lan.leasetime='12h'
EOF

# 配置无线
echo "配置无线..."
uci batch << EOF
set wireless.radio0=wifi-device
set wireless.radio0.type='mac80211'
set wireless.radio0.channel='6'
set wireless.radio0.hwmode='11g'
set wireless.radio0.htmode='HT20'
set wireless.radio0.country='CN'
set wireless.radio0.disabled='0'
set wireless.default_radio0=wifi-iface
set wireless.default_radio0.device='radio0'
set wireless.default_radio0.network='lan'
set wireless.default_radio0.mode='ap'
set wireless.default_radio0.ssid='AR9331-WiFi'
set wireless.default_radio0.encryption='psk2'
set wireless.default_radio0.key='12345678'
EOF

# 提交更改
echo "提交配置更改..."
uci commit network
uci commit dhcp
uci commit wireless

# 设置系统时区
uci set system.@system[0].timezone='CST-8'
uci set system.@system[0].zonename='Asia/Shanghai'
uci commit system

# 设置主机名
uci set system.@system[0].hostname='AR9331-Router'
uci commit system

# 重启服务
echo "重启网络服务..."
/etc/init.d/network restart

echo "启用无线..."
wifi up

echo "=== 配置完成 ==="
echo "LAN IP: 192.168.1.1"
echo "WiFi SSID: AR9331-WiFi"
echo "WiFi Password: 12345678"

# 标记脚本为已执行，避免下次启动再次执行
touch /etc/uci-defaults/ar9331-configured

exit 0
