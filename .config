#!/bin/bash

echo "开始配置AR9331编译环境..."

cd openwrt

# 清理旧配置
make clean
rm -f .config
rm -f .config.old

# 设置目标
cat > .config << 'EOF'
CONFIG_TARGET_ath79=y
CONFIG_TARGET_ath79_generic=y
CONFIG_TARGET_ath79_generic_DEVICE_tplink_tl-wr710n-v2.1=y
CONFIG_TARGET_MULTI_PROFILE=y
CONFIG_TARGET_PER_DEVICE_ROOTFS=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_ROOTFS_PARTSIZE=48
EOF

# 基础内核模块
cat >> .config << 'EOF'
CONFIG_PACKAGE_kmod-ath9k=y
CONFIG_PACKAGE_kmod-gpio-button-hotplug=y
CONFIG_PACKAGE_kmod-leds-gpio=y
CONFIG_PACKAGE_kmod-ledtrig-default-on=y
CONFIG_PACKAGE_kmod-ledtrig-netdev=y
CONFIG_PACKAGE_kmod-ledtrig-timer=y
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_ath9k-htc-firmware=y
EOF

# 网络配置 - 只选一个版本
cat >> .config << 'EOF'
# 选择 dnsmasq 而非 dnsmasq-full
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_dnsmasq_full=n
CONFIG_PACKAGE_dnsmasq-dhcpv6=n

# 选择 odhcpd 而非 odhcpd-ipv6only
CONFIG_PACKAGE_odhcpd=y
CONFIG_PACKAGE_odhcpd-ipv6only=n

CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=n
CONFIG_PACKAGE_iptables-mod-ipopt=n
CONFIG_PACKAGE_iw=y
CONFIG_PACKAGE_iwinfo=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_hostapd-common=y
EOF

# 系统工具 - 精简
cat >> .config << 'EOF'
CONFIG_PACKAGE_busybox=y
CONFIG_BUSYBOX_CUSTOM=y
CONFIG_BUSYBOX_CONFIG_FEATURE_EDITING=n
CONFIG_BUSYBOX_CONFIG_FEATURE_EDITING_HISTORY=0
CONFIG_BUSYBOX_CONFIG_HUSH=n
CONFIG_BUSYBOX_CONFIG_ASH_OPTIMIZE_FOR_SIZE=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_uci=y
CONFIG_PACKAGE_ubus=y
CONFIG_PACKAGE_ubusd=y
CONFIG_PACKAGE_libubus=y
CONFIG_PACKAGE_libblobmsg-json=y
CONFIG_PACKAGE_libjson-c=y
CONFIG_PACKAGE_libuci=y
CONFIG_PACKAGE_libuclient=y
CONFIG_PACKAGE_libnl-tiny=y
CONFIG_PACKAGE_libpthread=y
EOF

# 禁用所有LUCI
cat >> .config << 'EOF'
# 禁用LUCI及其所有组件
CONFIG_PACKAGE_luci=n
CONFIG_PACKAGE_luci-base=n
CONFIG_PACKAGE_luci-app-firewall=n
CONFIG_PACKAGE_luci-app-opkg=n
CONFIG_PACKAGE_luci-app-turboacc=n
CONFIG_PACKAGE_luci-app-filetransfer=n
CONFIG_PACKAGE_luci-theme-bootstrap=n
CONFIG_PACKAGE_luci-mod-admin-full=n
CONFIG_PACKAGE_luci-mod-status=n
CONFIG_PACKAGE_luci-mod-system=n
CONFIG_PACKAGE_luci-mod-network=n
CONFIG_PACKAGE_luci-proto-ppp=n
CONFIG_PACKAGE_luci-proto-ipv6=n
CONFIG_PACKAGE_luci-lib-base=n
CONFIG_PACKAGE_luci-lib-fs=n
CONFIG_PACKAGE_luci-lib-ip=n
CONFIG_PACKAGE_luci-lib-jsonc=n
CONFIG_PACKAGE_luci-lib-nixio=n
CONFIG_PACKAGE_luci-compat=n
CONFIG_PACKAGE_uhttpd=n
EOF

echo "配置完成！"
echo "检查冲突包配置..."
grep -E "dnsmasq|odhcpd" .config
